WITH PIPELINE AS
(
SELECT 
	SC1010.C1_FILIAL AS 'FILIAL', 
	SC1010.C1_LOCAL AS 'LOCAL',
	SC1010.C1_PRODUTO AS 'CODIGO', 
	(SC1010.C1_QUANT-SC1010.C1_QUJE) AS 'QTDE_FALTA',
	'SC' AS 'PROCESSO',
	(
		SELECT MAX(LastUpdateDate)
		FROM
		(VALUES (SC1010.C1_DTLIB1),(SC1010.C1_DTLIB2),(SC1010.C1_DTLIB3),(SC1010.C1_DTLIB4),(SC1010.C1_DTLIB5),(SC1010.C1_DTLIB6),(SC1010.C1_DTLIB7),(SC1010.C1_EMISSAO),(SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate)
	) AS 'DATA_APROV' -- BUSCA A ULTIMA DATA DE ATUALIZAÇÃO DO PROCESSO (DATA DE APROVAÇÃO PARA SC APROVADAS)
FROM PROTHEUS.dbo.SC1010 SC1010
WHERE
	(SC1010.D_E_L_E_T_<>'*') -- DESCONSIDERA DELETADOS
	AND (SC1010.C1_EMISSAO>=DATEADD(DAY,-365,GETDATE()) AND SC1010.C1_EMISSAO<=GETDATE()) --UM ANO
	AND (SC1010.C1_RESIDUO=' ') --DESCONSIDERA ELIM POR RESIDUO
	AND SC1010.C1_TPCOMPR='1' -- ESTOQUE
	AND SC1010.C1_QUJE<SC1010.C1_QUANT --NÃO ATENDIDOS
	AND (SC1010.C1_APROV<>'R') --DESCONSIDERA REJEITADOS
	AND SC1010.C1_CLVL <> '001' -- DESCONSIDERA MOBILIZAÇÃO

UNION ALL

SELECT
	SC7010.C7_FILIAL AS 'FILIAL',
	SC7010.C7_LOCAL AS 'LOCAL',
	SC7010.C7_PRODUTO AS 'CODIGO',
	SC7010.C7_QUANT-(SC7010.C7_QUJE+SC7010.C7_QTDACLA) AS 'QTDE_FALTA',
	'PC' AS 'PROCESSO',
	--[ATENÇÃO] A DT DE APROVAÇÃO É DA SC CORRESPONDENTE
	(
		SELECT MAX(LastUpdateDate)
		FROM
		(VALUES (SC1010.C1_DTLIB1),(SC1010.C1_DTLIB2),(SC1010.C1_DTLIB3),(SC1010.C1_DTLIB4),(SC1010.C1_DTLIB5),(SC1010.C1_DTLIB6),(SC1010.C1_DTLIB7),(SC1010.C1_EMISSAO),(SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate)
	) AS 'DATA_APROV' -- BUSCA A ULTIMA DATA DE ATUALIZAÇÃO DO PROCESSO (DATA DE APROVAÇÃO PARA SC APROVADAS)
FROM PROTHEUS.dbo.SC7010 SC7010	
	LEFT JOIN PROTHEUS.dbo.SC1010 SC1010 ON SC1010.C1_NUM = SC7010.C7_NUMSC AND SC1010.C1_ITEM = SC7010.C7_ITEMSC
WHERE 
	(SC7010.C7_EMISSAO>=DATEADD(DAY,-365,GETDATE()) AND SC7010.C7_EMISSAO<=GETDATE()) AND
	(SC7010.D_E_L_E_T_<>'*') AND
	SC7010.C7_TPCOMPR = 1 AND -- ESTOQUE
	(SC7010.C7_CONAPRO <> 'R') AND
	(SC7010.C7_QUJE+SC7010.C7_QTDACLA)<SC7010.C7_QUANT AND
	(SC7010.C7_RESIDUO=' ') AND
	SC7010.C7_CLVL<>'001' AND
	SC7010.C7_ENCER <> 'E'

UNION ALL

SELECT
	SD1010.D1_FILIAL AS 'FILIAL',
	SD1010.D1_LOCAL AS 'LOCAL',
	SD1010.D1_COD AS 'CODIGO',
	SD1010.D1_QUANT AS 'QTDE_DOC',
	CASE WHEN SD1010.D1_PEDIDO = '' THEN 'PV' ELSE 'PN' END AS 'PROCESSO',
	--[ATENÇÃO] A DT DE APROVAÇÃO É DA SC CORRESPONDENTE
	ISNULL((
		SELECT MAX(LastUpdateDate)
		FROM
		(VALUES (SC1010.C1_DTLIB1),(SC1010.C1_DTLIB2),(SC1010.C1_DTLIB3),(SC1010.C1_DTLIB4),(SC1010.C1_DTLIB5),(SC1010.C1_DTLIB6),(SC1010.C1_DTLIB7),(SC1010.C1_EMISSAO),(SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate)
	), SF1010.F1_DTDIGIT) AS 'DATA_APROV' -- BUSCA A ULTIMA DATA DE ATUALIZAÇÃO DO PROCESSO (DATA DE APROVAÇÃO PARA SC APROVADAS)
FROM PROTHEUS.dbo.SD1010 SD1010
	LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA
	LEFT JOIN PROTHEUS.dbo.SC7010 SC7010 ON (SD1010.D1_PEDIDO=SC7010.C7_NUM AND SD1010.D1_ITEMPC=SC7010.C7_ITEM)
	LEFT JOIN PROTHEUS.dbo.SC1010 SC1010 ON (SC7010.C7_NUMSC=SC1010.C1_NUM AND SC7010.C7_ITEMSC=SC1010.C1_ITEM)	
WHERE
	(SD1010.D1_CC='' AND SD1010.D1_TES='') AND
	(SD1010.D_E_L_E_T_<>'*') AND
	(SF1010.F1_DTDIGIT>=DATEADD(DAY,-365,GETDATE()) AND SF1010.F1_DTDIGIT<=GETDATE())

UNION ALL

SELECT
	Z22010.Z22_FILIAL AS 'FILIAL',
	Z22010.Z22_ALMDES AS 'LOCAL',
	Z22010.Z22_PRDORI AS 'CODIGO',
	Z22010.Z22_QUANT AS 'QTDE_FALTA',
	'TI' AS 'PROCESSO',
	Z22010.Z22_EMISSA AS 'DATA_APROV'
FROM PROTHEUS.dbo.Z22010 Z22010
WHERE
	(Z22010.D_E_L_E_T_ <>'*')
	AND (Z22010.Z22_SD3DOC='')
	AND Z22010.Z22_APROV NOT IN ('R', 'L', 'X')
)
/* RESUMO ANALÍTICO */
--SELECT
--	*,
--	DATEDIFF(DAY, PIP.DATA_APROV, GETDATE()) AS TEMPO_ESPERA
--FROM PIPELINE AS PIP
--WHERE PIP.FILIAL = '02' AND PIP.LOCAL = '25' -- EXEMPLO FIXANDO ARMAZÉM

/* RESUMO SINTÉTICO */
SELECT
	PIP.FILIAL,
	PIP.LOCAL,
	PIP.CODIGO,
	SUM(PIP.QTDE_FALTA) AS QTD_PIPELINE,
	MIN(DATEDIFF(DAY, PIP.DATA_APROV, GETDATE())) AS TEMPO_ESPERA
FROM PIPELINE AS PIP
--WHERE PIP.FILIAL = '02' AND PIP.LOCAL = '25' -- EXEMPLO FIXANDO ARMAZÉM
GROUP BY 
	PIP.FILIAL,
	PIP.LOCAL,
	PIP.CODIGO