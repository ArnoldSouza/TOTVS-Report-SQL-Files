SELECT
	CAST(SCP010.CP_EMISSAO AS DATETIME) AS 'DT EMISSÃO', 
	Case RTrim(Coalesce(CP_DTLIB1,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB1, 112)END as 'DT LIBERADO1',
	Case RTrim(Coalesce(CP_DTLIB2,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB2, 112)END as 'DT LIBERADO2',
	Case RTrim(Coalesce(CP_DTLIB3,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB3, 112)END as 'DT LIBERADO3',
	Case RTrim(Coalesce(CP_DTLIB4,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB4, 112)END as 'DT LIBERADO4',
	Case RTrim(Coalesce(CP_DTLIB5,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB5, 112)END as 'DT LIBERADO5',
	Case RTrim(Coalesce(CP_DTLIB6,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB6, 112)END as 'DT LIBERADO6',
	Case RTrim(Coalesce(CP_DTLIB7,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB7, 112)END as 'DT LIBERADO7',
	
	REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ') AS 'REGIONAL',
	REPLACE(RTRIM(CTT010.CTT_DESC01),'  ',' ') AS 'CENTRO DE CUSTO',
	IIF(
			REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', '')=REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' '),
			REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', ''),
			REPLACE(REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', ''), REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ')+' ', '')
	) AS 'POLO',
	REPLACE(REPLACE(REPLACE(RTRIM(CTT_XSERVI),'_',' '),'SERVICO ', ''),REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ')+' ', '') AS 'SERVIÇO',
	SD3010.D3_FILIAL AS 'FILIAL',
	SD3010.D3_LOCAL AS 'ARMAZÉM', 
	SD3010.D3_FILIAL+SD3010.D3_LOCAL+' - '+RTRIM(Z01010.Z01_DESC) AS 'DESC_ALMOX', 
	CASE WHEN Z01010.Z01_TME = '001' THEN 'ENDICON - MATERIAIS NOVOS' WHEN Z01010.Z01_TME = '002' THEN 'CLIENTE' WHEN Z01010.Z01_TME = '005' THEN 'ATIVO' WHEN Z01010.Z01_TME = '006' THEN 'ENDICON - MATERIAIS USADOS' ELSE 'ERRO' END AS 'TIPO ARMAZÉM',
	CASE WHEN SD3010.D3_TM = '501' THEN 'SAÍDA - APLICAÇÃO SA ENDICON' WHEN SD3010.D3_TM = '502' THEN 'SAÍDA - APLICAÇÃO SA CLIENTE' WHEN SD3010.D3_TM = '505' THEN 'SAÍDA - APLICAÇÃO SA ATIVO' WHEN SD3010.D3_TM = '506' THEN 'SAÍDA - ERRO SA S/ESTOQUE' ELSE 'ERRO - TM NOVA - SAÍDA' END AS 'TIPO DE MOVIMENTO',
	SD3010.D3_TM AS 'TM-2', 
	SD3010.D3_CF AS 'CF',  
	'SAIDA' AS 'TIPO MOV', 
	SD3010.D3_DOC AS 'DOCUMENTO RM', 
	RTRIM(SD3010.D3_COD) AS 'COD', 
	RTRIM(SB1010.B1_DESC) AS 'DESCRIÇÃO', 
	SD3010.D3_UM AS 'UND',  
	SD3010.D3_QUANT*-1 AS 'QTDE',  
	CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'EMISSÃO', 
	LEFT(SD3010.D3_EMISSAO,6) AS 'ANO-MÊS', 
	SD3010.D3_OSCLI AS 'HORA ENTREGA', 
	SD3010.D3_USUARIO AS 'ALMOXARIFE', 
	SD3010.D3_CLVL AS 'OBRA/PROJETO', 
	CTH010.CTH_DESC01 AS 'DESC OBRA', 
	SD3010.D3_TIPO AS 'TIPO',
	RTRIM(SD3010.D3_CONTA) AS 'CONTA CONTABIL', 
	RTRIM(CT1010.CT1_DESC01) AS 'DESC CONTA', 
	SD3010.D3_GRUPO AS 'GRUPO', 
	RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',  
	RTRIM(SD3010.D3_CC) AS 'CENTRO DE CUSTO', 
	RTRIM(CTT010.CTT_DESC01) AS 'DESC CENTRO DE CUSTO', 
	SD3010.D3_ESTORNO AS 'ESTORNO',  
	SD3010.D3_ITEMCTA AS 'CARRO',  
	SD3010.D3_FORNECE AS 'FORNECEDOR',  
	SD3010.D3_MEMO AS 'OBSERVACAO',  
	SD3010.D3_CUSTO1*-1 AS 'CUSTO TOTAL - SISTEMA', 
	SB1010.B1_UPRC AS 'VAL UND ULT. PREÇ. COMPRA', 
	(SB1010.B1_UPRC*SD3010.D3_QUANT)*-1 AS 'VAL TOTAL ULT. PREC. COMPRA', 
	CASE WHEN SD3010.D3_CLVL = '001      ' THEN 'INVESTIMENTO' ELSE 'CUSTO' END AS 'INVEST-CUST', 
	SUBSTRING(SD3010.D3_EMISSAO,5,2)+' - '+LEFT(SD3010.D3_EMISSAO,4) AS 'ANO-MÊS2',
	SD3010.D3_FORNECE AS 'MATRICULA',
	CASE WHEN SD3010.D3_FORNECE='      ' THEN '' ELSE RTRIM(SA2010.A2_NOME) END AS 'NOME',
	--DADOS DE SA
	RTRIM(SCQ010.CQ_NUM) AS 'NUM SA',
	RTRIM(SCP010.CP_SOLICIT) AS 'SOLICITANTE SA',
	RTRIM(SCP010.CP_OBS) AS 'OBS SA',
	CASE 
		WHEN SCP010.CP_FORNECE='      ' 
			THEN '' 
		ELSE RTRIM(SCP010.CP_FORNECE) 
	END+'-'+RTRIM(FUNCIONARIO.A2_NOME) AS 'MATRICULA'
		
FROM PROTHEUS.dbo.SD3010 SD3010 
	LEFT JOIN PROTHEUS.dbo.CT1010 CT1010 ON SD3010.D3_CONTA=CT1010.CT1_CONTA AND CT1010.D_E_L_E_T_ <> '*' 
	LEFT JOIN PROTHEUS.dbo.CTH010 CTH010 ON SD3010.D3_CLVL=CTH010.CTH_CLVL AND CTH010.D_E_L_E_T_ <> '*' 
	LEFT JOIN PROTHEUS.dbo.CTT010 CTT010 ON SD3010.D3_CC=CTT010.CTT_CUSTO AND CTT010.D_E_L_E_T_ <> '*'  
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*' 
	LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SD3010.D3_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_ <> '*'  
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
	LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON SA2010.A2_COD=SD3010.D3_FORNECE AND SA2010.A2_COD<>'' AND SA2010.D_E_L_E_T_ <> '*'
	--DADOS DE SA
	LEFT JOIN PROTHEUS.dbo.SCQ010 SCQ010 ON SD3010.D3_NUMSEQ=SCQ010.CQ_NUMREQ AND SCQ010.D_E_L_E_T_ <> '*'
	LEFT JOIN PROTHEUS.dbo.SCP010 SCP010 ON SCP010.CP_NUM+SCP010.CP_ITEM=SCQ010.CQ_NUM+SCQ010.CQ_ITEM AND SCP010.D_E_L_E_T_ <> '*'
	LEFT JOIN PROTHEUS.dbo.SA2010 FUNCIONARIO ON  FUNCIONARIO.A2_COD=SCP010.CP_FORNECE AND FUNCIONARIO.A2_COD<>'' AND FUNCIONARIO.D_E_L_E_T_ <> '*'
	
WHERE
	(SD3010.D_E_L_E_T_<>'*') AND
	(LEFT(SD3010.D3_CF,2) = 'RE') AND
	(SD3010.D3_ESTORNO='') AND
	((SD3010.D3_DOC NOT LIKE '%INVENT%') AND (SD3010.D3_TM<>'503')) AND --DESCONSIDERA REGULARIZAÇÕES DE INVENTÁRIO
	(SD3010.D3_TM<>'999') AND --DESCONSIDERA TRANSFERÊNCIA
	(SD3010.D3_TM<>'504') AND --DESCONSIDERA OUTROS MOVIMENTOS
	-- (SD3010.D3_FILIAL='02') AND (SD3010.D3_LOCAL='01') AND
	(SD3010.D3_EMISSAO>='20180101') AND (SD3010.D3_EMISSAO<='20191231') --AND
	--(CTT010.CTT_DESC01 LIKE '%SERRA%')

Union ALL

SELECT
	CAST(SCP010.CP_EMISSAO AS DATETIME) AS 'DT EMISSÃO', 
	Case RTrim(Coalesce(CP_DTLIB1,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB1, 112)END as 'DT LIBERADO1',
	Case RTrim(Coalesce(CP_DTLIB2,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB2, 112)END as 'DT LIBERADO2',
	Case RTrim(Coalesce(CP_DTLIB3,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB3, 112)END as 'DT LIBERADO3',
	Case RTrim(Coalesce(CP_DTLIB4,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB4, 112)END as 'DT LIBERADO4',
	Case RTrim(Coalesce(CP_DTLIB5,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB5, 112)END as 'DT LIBERADO5',
	Case RTrim(Coalesce(CP_DTLIB6,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB6, 112)END as 'DT LIBERADO6',
	Case RTrim(Coalesce(CP_DTLIB7,'')) WHEN ''  THEN Null ELSE convert(datetime, CP_DTLIB7, 112)END as 'DT LIBERADO7',
	
	REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ') AS 'REGIONAL',
	REPLACE(RTRIM(CTT010.CTT_DESC01),'  ',' ') AS 'CENTRO DE CUSTO',
	IIF(
			REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', '')=REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' '),
			REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', ''),
			REPLACE(REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', ''), REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ')+' ', '')
	) AS 'POLO',
	REPLACE(REPLACE(REPLACE(RTRIM(CTT_XSERVI),'_',' '),'SERVICO ', ''),REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ')+' ', '') AS 'SERVIÇO',
	SD3010.D3_FILIAL AS 'FILIAL', 
	SD3010.D3_LOCAL AS 'ARMAZÉM', 
	SD3010.D3_FILIAL+SD3010.D3_LOCAL+' - '+RTRIM(Z01010.Z01_DESC) AS 'DESC_ALMOX', 
	CASE WHEN Z01010.Z01_TME = '001' THEN 'ENDICON - MATERIAIS NOVOS' WHEN Z01010.Z01_TME = '002' THEN 'CLIENTE' WHEN Z01010.Z01_TME = '005' THEN 'ATIVO' WHEN Z01010.Z01_TME = '006' THEN 'ENDICON - MATERIAIS USADOS' ELSE 'ERRO' END AS 'TIPO ARMAZÉM',
	CASE WHEN SD3010.D3_TM = '001' THEN 'ENTRADA - DEVOLUÇÃO SA ENDICON' WHEN SD3010.D3_TM = '002' THEN 'ENTRADA - DEVOLUÇÃO SA CLIENTE' WHEN SD3010.D3_TM = '005' THEN 'ENTRADA - DEVOLUÇÃO SA ATIVO' ELSE 'ERRO - TM NOVA - ENTRADA' END AS 'TIPO DE MOVIMENTO',
	SD3010.D3_TM AS 'TM-2', SD3010.D3_CF AS 'CF',  
	'ENTRADA' AS 'TIPO MOV', SD3010.D3_DOC AS 'DOCUMENTO RM', 
	RTRIM(SD3010.D3_COD) AS 'COD', 
	RTRIM(SB1010.B1_DESC) AS 'DESCRIÇÃO', 
	SD3010.D3_UM AS 'UND',  SD3010.D3_QUANT AS 'QTDE',  
	CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'EMISSÃO', 
	LEFT(SD3010.D3_EMISSAO,6) AS 'ANO-MÊS', 
	SD3010.D3_OSCLI AS 'HORA ENTREGA', 
	SD3010.D3_USUARIO AS 'ALMOXARIFE', 
	SD3010.D3_CLVL AS 'OBRA/PROJETO', 
	CTH010.CTH_DESC01 AS 'DESC OBRA', 
	SD3010.D3_TIPO AS 'TIPO', 
	RTRIM(SD3010.D3_CONTA) AS 'CONTA CONTABIL',
	RTRIM(CT1010.CT1_DESC01) AS 'DESC CONTA', 
	SD3010.D3_GRUPO AS 'GRUPO', 
	RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',  
	RTRIM(SD3010.D3_CC) AS 'CENTRO DE CUSTO', 
	RTRIM(CTT010.CTT_DESC01) AS 'DESC CENTRO DE CUSTO', 
	SD3010.D3_ESTORNO AS 'ESTORNO',  
	SD3010.D3_ITEMCTA AS 'CARRO',  
	SD3010.D3_FORNECE AS 'FORNECEDOR',  
	SD3010.D3_MEMO AS 'OBSERVACAO ',  
	SD3010.D3_CUSTO1 AS 'CUSTO TOTAL - SISTEMA', 
	SB1010.B1_UPRC AS 'VAL UND ULT. PREÇ. COMPRA', 
	(SB1010.B1_UPRC*SD3010.D3_QUANT) AS 'VAL TOTAL ULT. PREC. COMPRA', 
	CASE WHEN SD3010.D3_CLVL = '001      ' THEN 'INVESTIMENTO' ELSE 'CUSTO' END AS 'INVEST-CUST', 
	SUBSTRING(SD3010.D3_EMISSAO,5,2)+' - '+LEFT(SD3010.D3_EMISSAO,4) AS 'ANO-MÊS2',
	SD3010.D3_FORNECE AS 'MATRICULA',
	CASE WHEN SD3010.D3_FORNECE='      ' THEN '' ELSE RTRIM(SA2010.A2_NOME) END AS 'NOME',
	--DADOS DE SA
	RTRIM(SCQ010.CQ_NUM) AS 'NUM SA',
	RTRIM(SCP010.CP_SOLICIT) AS 'SOLICITANTE SA',
	RTRIM(SCP010.CP_OBS) AS 'OBS SA',
	CASE 
		WHEN SCP010.CP_FORNECE='      ' 
			THEN '' 
		ELSE RTRIM(SCP010.CP_FORNECE) 
	END+'-'+RTRIM(FUNCIONARIO.A2_NOME) AS 'MATRICULA'

FROM PROTHEUS.dbo.SD3010 SD3010 
	LEFT JOIN PROTHEUS.dbo.CT1010 CT1010 ON SD3010.D3_CONTA=CT1010.CT1_CONTA AND CT1010.D_E_L_E_T_ <> '*' 
	LEFT JOIN PROTHEUS.dbo.CTH010 CTH010 ON SD3010.D3_CLVL=CTH010.CTH_CLVL AND CTH010.D_E_L_E_T_ <> '*' 
	LEFT JOIN PROTHEUS.dbo.CTT010 CTT010 ON SD3010.D3_CC=CTT010.CTT_CUSTO AND CTT010.D_E_L_E_T_ <> '*'  
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*' 
	LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SD3010.D3_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_ <> '*'  
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
	LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON SA2010.A2_COD=SD3010.D3_FORNECE AND SA2010.A2_COD<>'' AND SA2010.D_E_L_E_T_ <> '*'
	--DADOS DE SA
	LEFT JOIN PROTHEUS.dbo.SCQ010 SCQ010 ON SD3010.D3_NUMSEQ=SCQ010.CQ_NUMREQ AND SCQ010.D_E_L_E_T_ <> '*'
	LEFT JOIN PROTHEUS.dbo.SCP010 SCP010 ON SCP010.CP_NUM+SCP010.CP_ITEM=SCQ010.CQ_NUM+SCQ010.CQ_ITEM AND SCP010.D_E_L_E_T_ <> '*'
	LEFT JOIN PROTHEUS.dbo.SA2010 FUNCIONARIO ON  FUNCIONARIO.A2_COD=SCP010.CP_FORNECE AND FUNCIONARIO.A2_COD<>'' AND FUNCIONARIO.D_E_L_E_T_ <> '*'

WHERE
	(SD3010.D_E_L_E_T_<>'*') AND
	(LEFT(SD3010.D3_CF,2) = 'DE') AND
	(SD3010.D3_ESTORNO='') AND
	((SD3010.D3_DOC NOT LIKE '%INVENT%') AND (SD3010.D3_TM<>'003')) AND --DESCONSIDERA REGULARIZAÇÕES DE INVENTÁRIO
	(SD3010.D3_TM<>'499') AND --DESCONSIDERA TRANSFERÊNCIA
	(SD3010.D3_TM<>'004') AND --DESCONSIDERA OUTROS MOVIMENTOS
	-- (SD3010.D3_FILIAL='02') AND (SD3010.D3_LOCAL='01') AND
	(SD3010.D3_EMISSAO>='20180101') AND (SD3010.D3_EMISSAO<='20191231') --AND
	--(CTT010.CTT_DESC01 LIKE '%SERRA%' )