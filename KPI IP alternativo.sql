--DADOS DE FATURAMENTO

IF OBJECT_ID(N'tempdb..#TempConsult', N'U') IS NOT NULL   
DROP TABLE #TempConsult

CREATE TABLE #TempConsult
	(
	DESCRICAO_ARMAZEM VARCHAR(37) NULL, 
	NUM_PROCESSO VARCHAR(11) NULL,
	DATA_PROCESSO VARCHAR(8) NULL,
	VALOR_TOTAL REAL NULL
	)
INSERT INTO #TempConsult
	VALUES
		('0221 - ALM.IP BELEM-MANUTENCAO       ','FATURAMENTO','20160701',759277.20),
		('0221 - ALM.IP BELEM-MANUTENCAO       ','FATURAMENTO','20160801',596773.10),
		('0221 - ALM.IP BELEM-MANUTENCAO       ','FATURAMENTO','20160901',596773.10),
		('0221 - ALM.IP BELEM-MANUTENCAO       ','FATURAMENTO','20161001',596773.10),
		('0221 - ALM.IP BELEM-MANUTENCAO       ','FATURAMENTO','20161101',596773.10),
		('0221 - ALM.IP BELEM-MANUTENCAO       ','FATURAMENTO','20161201',596773.10),

		('0222 - ALM.IP BELEM-CONSTRUCAO       ','FATURAMENTO','20160701',690185.81),
		('0222 - ALM.IP BELEM-CONSTRUCAO       ','FATURAMENTO','20160801',1722446.53),
		('0222 - ALM.IP BELEM-CONSTRUCAO       ','FATURAMENTO','20160901',1021831.64),
		('0222 - ALM.IP BELEM-CONSTRUCAO       ','FATURAMENTO','20161001',1621831.64),
		('0222 - ALM.IP BELEM-CONSTRUCAO       ','FATURAMENTO','20161101',2021831.64),
		('0222 - ALM.IP BELEM-CONSTRUCAO       ','FATURAMENTO','20161201',1921831.64)

SELECT 
	DESCRICAO_ARMAZEM AS 'DESCRIÇÃO ARMAZÉM', 
	NUM_PROCESSO AS 'NUM PROCESSO', 
	CAST(DATA_PROCESSO AS DATETIME) AS 'DATA',
	VALOR_TOTAL AS 'VALOR TOTAL', 
	'FATURAMENTO' AS 'TIPO PROCESSO'
FROM #TempConsult

UNION ALL

--SOLICITAÇÃO DE COMPRAS
SELECT 
	SC1010.C1_FILIAL+SC1010.C1_LOCAL+' - '+Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
	SC1010.C1_NUM AS 'NUM PROCESSO', 
	Case RTrim(Coalesce(SC1010.C1_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_EMISSAO, 112) END AS 'DATA',
	SUM(SC1010.C1_VTOTAL) AS 'VALOR TOTAL', 
	'SC' AS 'TIPO PROCESSO'
FROM PROTHEUS.dbo.SC1010 SC1010
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SC1010.C1_FILIAL + SC1010.C1_LOCAL)
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SC1010.C1_PRODUTO=SB1010.B1_COD
WHERE
	(SC1010.D_E_L_E_T_<>'*') AND
	(SC1010.C1_EMISSAO>='20160601') AND
	(SC1010.C1_RESIDUO= ' ') AND 
	--GRUPOS QUE NÃO PERTENCEM À ANÁLISE (GERALMENTE PARTENCENTES AO RH)
	(SB1010.B1_GRUPO NOT IN ('1060','0174','3001','3005','0702','0703','0707','0710','1024','1025','3002','3003','3007','3050','3060','0720','0752','1200','3004','1203','0700','0706','0743','0780','0781','0782','0820','0822','0823','0825','1022','1065','1202','1204','1205','1206','1208','1211','1213','1215','1219','3000','3006','3008','3054','4006','7000')) AND
	(SC1010.C1_APROV='L' OR SC1010.C1_APROV='B') AND
	(SC1010.C1_FILIAL='02' AND (SC1010.C1_LOCAL='21' OR SC1010.C1_LOCAL='22')) AND
	(SC1010.C1_CC = '          ')
GROUP BY
	SC1010.C1_FILIAL+SC1010.C1_LOCAL+' - '+Z01010.Z01_DESC,
	SC1010.C1_NUM,
	Case RTrim(Coalesce(SC1010.C1_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_EMISSAO, 112) END

UNION ALL 
	
--PEDIDO DE COMPRAS
SELECT
	SC7010.C7_FILIAL+SC7010.C7_LOCAL+' - '+Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
	SC7010.C7_NUM AS 'NUM PROCESSO',
	Case RTrim(Coalesce(SC7010.C7_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_EMISSAO, 112) END AS 'DATA',
	SUM(SC7010.C7_TOTAL) AS 'VALOR TOTAL',
	'PC' AS 'TIPO PROCESSO'
FROM PROTHEUS.dbo.SC7010 SC7010
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SC7010.C7_FILIAL+SC7010.C7_LOCAL)
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SC7010.C7_PRODUTO=SB1010.B1_COD
WHERE 
	(SC7010.C7_EMISSAO>='20160601') AND
	(SC7010.D_E_L_E_T_<>'*') AND 
	(SC7010.C7_CONAPRO='L') AND
	--GRUPOS QUE NÃO PERTENCEM À ANÁLISE (GERALMENTE PARTENCENTES AO RH)
	(SB1010.B1_GRUPO NOT IN ('1218','1060','0174','3001','3005','0702','0703','0707','0710','1024','1025','3002','3003','3007','3050','3060','0720','0752','1200','3004','1203','0700','0706','0743','0780','0781','0782','0820','0822','0823','0825','1022','1065','1202','1204','1205','1206','1208','1211','1213','1215','1219','3000','3006','3008','3054','4006','7000')) AND
	(SC7010.C7_RESIDUO=' ') AND
	(SC7010.C7_CC = '         ') AND
	(SC7010.C7_FILIAL='02' AND (SC7010.C7_LOCAL='22' OR SC7010.C7_LOCAL='21'))
GROUP BY
	SC7010.C7_FILIAL+SC7010.C7_LOCAL+' - '+Z01010.Z01_DESC ,
	SC7010.C7_NUM,
	Case RTrim(Coalesce(SC7010.C7_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_EMISSAO, 112) END

UNION ALL 
	
--PRÉ-NOTA	
SELECT
	SD1010.D1_FILIAL+SD1010.D1_LOCAL+' - '+Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
	SD1010.D1_DOC AS 'NUM PROCESSO',
	Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112)END AS 'DATA',
	SUM(SD1010.D1_TOTAL) AS 'VALOR TOTAL',
	'PN' AS 'TIPO PROCESSO'
FROM PROTHEUS.dbo.SD1010 SD1010
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SD1010.D1_FILIAL+SD1010.D1_LOCAL)
	LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA
WHERE 
	(SD1010.D_E_L_E_T_<>'*') AND
	(SD1010.D1_CC='          ' ) AND
	(SF1010.F1_DTDIGIT>='20160601') AND
	(SD1010.D1_FILIAL='02' AND (SD1010.D1_LOCAL='21' OR SD1010.D1_LOCAL='22'))
GROUP BY
	SD1010.D1_FILIAL+SD1010.D1_LOCAL+' - '+Z01010.Z01_DESC,
	SD1010.D1_DOC,
	Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112)END

UNION ALL 
	
--SOLICITAÇÃO AO ARMAZÉM
SELECT 
	SD3010.D3_FILIAL+SD3010.D3_LOCAL+' - '+Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
	SD3010.D3_DOC AS 'NUM PROCESSO', 
	CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'DATA',
	SUM((SB1010.B1_UPRC*SD3010.D3_QUANT)) AS 'VALOR TOTAL', 
	'SA' AS 'TIPO PROCESSO'
FROM PROTHEUS.dbo.SD3010 SD3010 
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*' 
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
WHERE
	(SD3010.D_E_L_E_T_<>'*') AND
	(LEFT(SD3010.D3_CF,2) = 'RE') AND
	(SD3010.D3_ESTORNO='') AND
	(SD3010.D3_DOC NOT LIKE '%INVENT%') AND
	(SD3010.D3_TM<>'999' AND SD3010.D3_TM<>'503' AND SD3010.D3_TM<>'504') AND
	(SD3010.D3_EMISSAO>='20160601')  AND
	(SD3010.D3_FILIAL='02' AND (SD3010.D3_LOCAL='21' OR SD3010.D3_LOCAL='22'))
GROUP BY
	SD3010.D3_FILIAL+SD3010.D3_LOCAL+' - '+Z01010.Z01_DESC,
	SD3010.D3_DOC,
	SD3010.D3_EMISSAO
UNION ALL 
SELECT 
	SD3010.D3_FILIAL+SD3010.D3_LOCAL+' - '+Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
	SD3010.D3_DOC AS 'NUM PROCESSO', 
	CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'DATA',
	SUM((SB1010.B1_UPRC*SD3010.D3_QUANT)*-1) AS 'VALOR TOTAL', 
	'SA' AS 'TIPO PROCESSO'
FROM PROTHEUS.dbo.SD3010 SD3010 
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*' 
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
WHERE
	(SD3010.D_E_L_E_T_<>'*') AND
	(LEFT(SD3010.D3_CF,2) = 'DE') AND
	(SD3010.D3_ESTORNO='') AND
	(SD3010.D3_DOC NOT LIKE '%INVENT%') AND
	(SD3010.D3_TM<>'499' AND SD3010.D3_TM<>'003' AND SD3010.D3_TM<>'004') AND
	(SD3010.D3_EMISSAO>='20160601')  AND
	(SD3010.D3_FILIAL='02' AND (SD3010.D3_LOCAL='21' OR SD3010.D3_LOCAL='22'))
GROUP BY
	SD3010.D3_FILIAL+SD3010.D3_LOCAL+' - '+Z01010.Z01_DESC,
	SD3010.D3_DOC,
	SD3010.D3_EMISSAO	