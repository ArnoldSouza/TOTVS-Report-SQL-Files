SELECT
	--IDENTIFICA LOCAL CASO TENHA CENTRO DE CUSTO
	ISNULL(REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' '),
		CASE
			WHEN SD1010.D1_FILIAL = '02' AND SD1010.D1_LOCAL = '22'	THEN 'IP BELEM'
			WHEN SD1010.D1_FILIAL = '07' AND SD1010.D1_LOCAL = '40'	THEN 'AMPLA'
			WHEN SD1010.D1_FILIAL = '12' AND SD1010.D1_LOCAL = '92'	THEN 'IP SANTAREM'
			WHEN SD1010.D1_FILIAL = '13' AND SD1010.D1_LOCAL = '95'	THEN 'COELBA'
			WHEN SD1010.D1_FILIAL = '09' AND SD1010.D1_LOCAL = '63'	THEN 'COELCE'
			WHEN SD1010.D1_FILIAL = '02' AND SD1010.D1_LOCAL = '11'	THEN 'BENGUI'
			WHEN SD1010.D1_FILIAL = '13' AND SD1010.D1_LOCAL = '03'	THEN 'COELBA'
			WHEN SD1010.D1_FILIAL = '02' AND SD1010.D1_LOCAL = '16'	THEN 'BENGUI'
			WHEN SD1010.D1_FILIAL = '12' AND SD1010.D1_LOCAL = '91'	THEN 'IP SANTAREM'
			WHEN SD1010.D1_FILIAL = '12' AND SD1010.D1_LOCAL = '90'	THEN 'CELPA CENTRO OESTE'
			WHEN SD1010.D1_FILIAL = '02' AND SD1010.D1_LOCAL = '01'	THEN 'BENGUI'
			WHEN SD1010.D1_FILIAL = '02' AND SD1010.D1_LOCAL = '21'	THEN 'IP BELEM'
			WHEN SD1010.D1_FILIAL = '02' AND SD1010.D1_LOCAL = '39'	THEN 'IP BELEM'
			WHEN SD1010.D1_FILIAL = '12' AND SD1010.D1_LOCAL = '94'	THEN 'CELPA OESTE'
			WHEN SD1010.D1_FILIAL = '02' AND SD1010.D1_LOCAL = '25'	THEN 'CELPA NORDESTE'
			WHEN SD1010.D1_FILIAL = '10' AND SD1010.D1_LOCAL = '03'	THEN 'CELG'
			WHEN SD1010.D1_FILIAL = '13' AND SD1010.D1_LOCAL = '96'	THEN 'COELBA'
			WHEN SD1010.D1_FILIAL = '13' AND SD1010.D1_LOCAL = '05'	THEN 'COELBA'
			WHEN SD1010.D1_FILIAL = '02' AND SD1010.D1_LOCAL = '18'	THEN 'CELPA NORDESTE'
			WHEN SD1010.D1_FILIAL = '12' AND SD1010.D1_LOCAL = '89'	THEN 'IP SANTAREM'
			WHEN SD1010.D1_FILIAL = '13' AND SD1010.D1_LOCAL = '04'	THEN 'COELBA'
			WHEN SD1010.D1_FILIAL = '09' AND SD1010.D1_LOCAL = '75'	THEN 'COELCE'
			WHEN SD1010.D1_FILIAL = '09' AND SD1010.D1_LOCAL = '65'	THEN 'COELCE'
			WHEN SD1010.D1_FILIAL = '09' AND SD1010.D1_LOCAL = '82'	THEN 'COELCE'
			WHEN SD1010.D1_FILIAL = '10' AND SD1010.D1_LOCAL = '04'	THEN 'CELG'
			WHEN SD1010.D1_FILIAL = '07' AND SD1010.D1_LOCAL = '43'	THEN 'AMPLA'
			WHEN SD1010.D1_FILIAL = '07' AND SD1010.D1_LOCAL = '53'	THEN 'AMPLA'
			WHEN SD1010.D1_FILIAL = '07' AND SD1010.D1_LOCAL = '50'	THEN 'AMPLA'
			WHEN SD1010.D1_FILIAL = '07' AND SD1010.D1_LOCAL = '49'	THEN 'AMPLA'
			WHEN SD1010.D1_FILIAL = '07' AND SD1010.D1_LOCAL = '54'	THEN 'AMPLA'
			WHEN SD1010.D1_FILIAL = '09' AND SD1010.D1_LOCAL = '59'	THEN 'COELCE'
			ELSE 'ERRO'
		END
	) AS 'REGIONAL',
	
	ISNULL(IIF(
		REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', '')=REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' '),
		REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', ''),
		REPLACE(REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', ''), REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ')+' ', '')
	),'ESTOQUE') AS 'POLO',
	
	SD1010.D1_FILIAL+SD1010.D1_LOCAL+'-'+Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
	CASE WHEN SF4010.F4_ESTOQUE = 'S' THEN 'SIM' ELSE 'NÃO' END AS 'ATUALIZOU ESTOQUE?',
	RTRIM(SD1010.D1_DOC) AS 'DOCUMENTO',
	SD1010.D1_ITEM AS 'ITEM',
	RTRIM(SD1010.D1_COD) AS 'CODIGO',
	RTRIM(SD1010.D1_DESCRI) AS 'DESCRIÇÃO',
	SD1010.D1_UM AS 'UND',
	SD1010.D1_QUANT AS 'QTDE DOC',
	SD1010.D1_PEDIDO AS 'NUM PEDIDO',
	SD1010.D1_ITEMPC AS 'ITEM PEDIDO',
	
	--DADOS DE PEDIDO DE COMPRA
	RTRIM(SC7010.C7_NUMSC) AS 'NUM SC',
	SC7010.C7_ITEMSC AS 'ITEM SC',
	SC7010.C7_OBS AS 'OBSERVAÇÃO',

	SD1010.D1_QTDPEDI AS 'QTDE PEDIDO',
	SD1010.D1_FORNECE AS 'FORNECEDOR',
	CASE WHEN SD1010.D1_FORNECE = '      ' THEN '' ELSE RTRIM(SA2010.A2_NOME)  END AS 'NOME FORNECEDOR',

	RTRIM(SB1010.B1_GRUPO) AS 'COD GRUPO',
	RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',

	SF1010.F1_NMUSER AS 'USUÁRIO INCLUIU PRENOTA',
	CASE WHEN SC7010.C7_APROV1='SISTEM' THEN 'AUTOMÁTICA' ELSE 'WORKFLOW' END AS 'PC: TP APROVAÇÃO',
	CASE WHEN SC1010.C1_TPCOMPR='2' THEN 'APLICAÇÃO DIRETA' WHEN SC1010.C1_TPCOMPR='1' THEN 'ESTOQUE' END AS 'TIPO DE COMPRA ',
	
	CASE WHEN RTRIM(SD1010.D1_CLVL)='001' THEN 'MOBILIZAÇÃO' ELSE 'CUSTO' END AS 'TP COMPRA',

	--DATA EM QUE A SC FOI CRIADA
	CONVERT(DATETIME,
				(
					SELECT MAX(LastUpdateDate)
					FROM (VALUES (SC1010.C1_EMISSAO), (SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate) 
				)
	, 112) AS 'SC: DT CRIAÇÃO',

	--DATA EM QUE A SC FOI APROVADA
	CONVERT(DATETIME,
				(
					SELECT MAX(LastUpdateDate)
					FROM (VALUES (SC1010.C1_DTLIB1),(SC1010.C1_DTLIB2),(SC1010.C1_DTLIB3),(SC1010.C1_DTLIB4),(SC1010.C1_DTLIB5),(SC1010.C1_DTLIB6),(SC1010.C1_DTLIB7), (SC1010.C1_EMISSAO), (SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate) 
				)
	, 112) AS 'SC: DT APROVAÇÃO',

	--DATA DE CRIAÇÃO DO PC
	CONVERT(DATETIME,
		(
			SELECT MAX(LastUpdateDate)
			FROM (VALUES (SC7010.C7_EMISSAO), (SC7010.C7_ALTDATA)) AS UpdateDate(LastUpdateDate) 
		)
	, 112) AS 'PC: DT APROVAÇÃO',

	--DATA DE APROVAÇÃO DO PC
	CONVERT(DATETIME,
		(
			SELECT MAX(LastUpdateDate)
			FROM (VALUES (SC7010.C7_DTLIB1),(SC7010.C7_DTLIB2),(SC7010.C7_DTLIB3),(SC7010.C7_DTLIB4),(SC7010.C7_DTLIB5),(SC7010.C7_DTLIB6),(SC7010.C7_DTLIB7), (SC7010.C7_EMISSAO), (SC7010.C7_ALTDATA)) AS UpdateDate(LastUpdateDate) 
		)
	, 112) AS 'PC: DT APROVAÇÃO',
	
	Case RTrim(Coalesce(SD1010.D1_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime,SD1010.D1_EMISSAO, 112)END AS 'PN: DT EMISSÃO', --DT EMISSÃO DA NF
	Case RTrim(Coalesce(SF1010.F1_RECBMTO,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_RECBMTO, 112)END AS 'PN: DT RECEBIMENTO', --DT EM QUE O MATERIAL FOI RECEBIDO
	Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112)END AS 'PN: DT DIGITAÇÃO', --DT EM QUE OCORREU A CLASSIFICAÇÃO
	Case RTrim(Coalesce(SC5010.C5_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime,SC5010.C5_EMISSAO, 112)END AS 'PV: DT EMISSÃO PV',
	Case RTrim(Coalesce(SD2010.D2_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime,SD2010.D2_EMISSAO, 112)END AS 'PV: DT EMISSÃO DOC',
	Case RTrim(Coalesce(SC5010.C5_DTLANC,'')) WHEN ''  THEN Null ELSE convert(datetime,SC5010.C5_DTLANC, 112)END AS 'PV: DT CONTABILIZAÇÃO',

	--DADOS DE TRANSFERÊNCIA EXTERNA
	---------------------------------------------------
	CASE WHEN SD2010.D2_SERIE='40' THEN 'FILIAL->FILIAL' ELSE 'MATRIZ->FILIAL' END AS 'TIPO TRANSF',
	SC5010.C5_FILIAL+SC6010.C6_LOCAL +'->'+ SC5010.C5_FILDEST+SC5010.C5_LOCDEST AS 'DE->PARA',
	SD2010.D2_PEDIDO AS 'NUM PV',
	SD2010.D2_ITEMPV AS 'ITEM PV',
	RTRIM(SC5010.C5_USUINL) AS 'USER PV',
	RTRIM(SC5010.C5_MENNOTA) AS 'OBS PV',
	CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), SC5010.C5_DSCSERV)) AS 'DESC. SERVIÇO'
FROM PROTHEUS.dbo.SD1010 SD1010
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON (Z01010.Z01_FILIAL=SD1010.D1_FILIAL AND Z01010.Z01_COD=SD1010.D1_LOCAL) AND Z01010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.CT1010 CT1010 ON SD1010.D1_CONTA=CT1010.CT1_CONTA AND CT1010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.CTT010 CTT010 ON SD1010.D1_CC=CTT010.CTT_CUSTO AND CTT010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.CTH010 CTH010 ON SD1010.D1_CLVL=CTH010.CTH_CLVL AND CTH010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON SD1010.D1_FORNECE=SA2010.A2_COD AND SD1010.D1_LOJA=SA2010.A2_LOJA AND SA2010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA AND SF1010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD1010.D1_TES AND SF4010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SX5010 SX5010 ON SX5010.X5_TABELA='13' AND SX5010.X5_CHAVE=SF4010.F4_CF AND SX5010.D_E_L_E_T_<>'*'
	--CONEXÃO SC E PC
	LEFT JOIN PROTHEUS.dbo.SC7010 SC7010 ON (SD1010.D1_PEDIDO=SC7010.C7_NUM AND SD1010.D1_ITEMPC=SC7010.C7_ITEM) AND SC7010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SC1010 SC1010 ON (SC7010.C7_NUMSC=SC1010.C1_NUM AND SC7010.C7_ITEMSC=SC1010.C1_ITEM) AND SC1010.D_E_L_E_T_<>'*'
	--CONEXÃO PRODUTOS
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD1010.D1_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_<>'*'
	-----------------------------------------------------------------------------------------------------------------------------------------------
	--CONEXÃO TRANFERÊNCIAS EXTERNAS (PV)
	LEFT JOIN
		(
			SELECT
				CLIENTE.A1_COD AS CLIENTE_COD,
				CLIENTE.A1_LOJA AS CLIENTE_LOJA,
				CLIENTE.A1_NREDUZ AS CLIENTE_NOME,
				CLIENTE.A1_END AS CLIENTE_END,
				CLIENTE.A1_EST AS CLIENTE_UF,
				CLIENTE.A1_MUN AS CLIENTE_MUN,
				CLIENTE.A1_BAIRRO AS CLIENTE_BAIRRO,
				CLIENTE.A1_CGC AS CLIENTE_CNPJ,
				FORNECE.A2_COD AS FORNECE_COD,
				FORNECE.A2_LOJA AS FORNECE_LOJA,
				FORNECE.A2_NREDUZ AS FORNECE_NOME,
				FORNECE.A2_END AS FORNECE_END,
				FORNECE.A2_BAIRRO AS FORNECE_BAIRRO,
				FORNECE.A2_EST AS FORNECE_UF,
				FORNECE.A2_MUN AS FORNECE_MUN,
				FORNECE.A2_CGC AS FORNECE_CNPJ
			FROM PROTHEUS.DBO.SA1010 CLIENTE
				LEFT JOIN PROTHEUS.DBO.SA2010 FORNECE ON A1_CGC=A2_CGC AND FORNECE.D_E_L_E_T_<>'*'
			WHERE
				CLIENTE.D_E_L_E_T_<>'*' AND
				CLIENTE.A1_NREDUZ LIKE '%ENDICON%' AND --SOMENTE FILIAIS ENDICON
				FORNECE.A2_COD <> '003333' --ESTE CODIGO COMPARTILHA O MESMO CNPJ DE OUTRA FILIAL
		) AS CLIENTE_FORNECEDOR ON SA2010.A2_CGC = CLIENTE_FORNECEDOR.[CLIENTE_CNPJ]
	--LINK COM ITENS DA NF SAÍDA
	LEFT JOIN PROTHEUS.dbo.SD2010 SD2010 ON SD1010.D1_DOC=SD2010.D2_DOC AND SD1010.D1_SERIE=SD2010.D2_SERIE AND RIGHT(SD1010.D1_ITEM,2)=SD2010.D2_ITEM AND SD2010.D2_CLIENTE = CLIENTE_FORNECEDOR.CLIENTE_COD AND SD2010.D2_LOJA = CLIENTE_FORNECEDOR.CLIENTE_LOJA AND SD2010.D_E_L_E_T_<>'*'
	--LINK COM O CABEÇALHO DO PV - PARA SAÍDA
	LEFT JOIN PROTHEUS.dbo.SC5010 SC5010 ON SC5010.C5_NUM=SD2010.D2_PEDIDO AND SD2010.D2_FILIAL=SC5010.C5_FILIAL AND SC5010.D_E_L_E_T_<>'*'
	--LINK COM CORPO DO PV
	LEFT JOIN PROTHEUS.dbo.SC6010 SC6010 ON SC6010.C6_FILIAL=SD2010.D2_FILIAL AND SC6010.C6_LOCAL = SD2010.D2_LOCAL AND SD2010.D2_PEDIDO = SC6010.C6_NUM AND SD2010.D2_ITEMPV = SC6010.C6_ITEM AND SC6010.D_E_L_E_T_<>'*'
WHERE
	SD1010.D1_FILIAL = '07' AND --FIXA UMA FILIAL
	((SF1010.F1_DTDIGIT>='20180101') AND (SF1010.F1_DTDIGIT<='20191231')) AND --ESTABELECE PERÍODO DE MEDIÇÃO
	(SD1010.D_E_L_E_T_<>'*') AND -- retira excluído excluído
	((SD1010.D1_CC = '         ') OR (SF4010.F4_ESTOQUE = 'S')) AND -- para estoque
	(SD1010.D1_QUANT<>0) AND --retira complemento de preço de frete
	(
		(SF4010.F4_TEXTO NOT LIKE '%*%') AND -- retira importação 1
		(SF1010.F1_ESPECIE <> 'SPE  ' OR SF1010.F1_ESPECIE <> 'SPE') AND -- retira importação 2
		(SF1010.F1_ESPECIE NOT LIKE 'NFE') -- retira importação 3
	) AND
	--(
	--	LEFT(SA2010.A2_CGC,8)<>'05061494' AND -- ENDICON
	--	SA2010.A2_CGC<>'07047251000170' -- COELCE
	--) AND -- RETIRA TRANSFERÊNCIA E ARMAZÉM CLIENTE
	(SD1010.D1_TES<>'   ') --AND --SOMENTE CLASSIFICADAS
	--(SC7010.C7_NUM <> '      ') AND -- RETIRA ALGUMAS PRENOTAS SEM MENÇÃO AO PC
	--(SD1010.D1_TES NOT IN ('417','451')) AND --retira TES de transf e cliente