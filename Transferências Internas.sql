SELECT
	Z22010.Z22_FILIAL AS 'FILIAL',
	
	RTRIM(Z22010.Z22_FILIAL+Z22010.Z22_ALMORI+' - '+(
		SELECT
			Z01010.Z01_DESC AS Z01_DESC
		FROM PROTHEUS.dbo.Z01010 Z01010
		WHERE 
			Z01010.Z01_CODGER = (Z22010.Z22_FILIAL + Z22010.Z22_ALMORI)
	)) AS 'ARMAZÉM ORIGEM',
	
	Z22010.Z22_DOC AS 'DOCUMENTO',
	
	(
		SELECT
			CASE WHEN Z01010.Z01_TME = '001' THEN 'ENDICON - MATERIAIS NOVOS' WHEN Z01010.Z01_TME = '002' THEN 'CLIENTE' WHEN Z01010.Z01_TME = '005' THEN 'ATIVO' WHEN Z01010.Z01_TME = '006' THEN 'ENDICON - MATERIAIS USADOS' ELSE 'ERRO' END AS 'TIPO ARMAZÉM'
		FROM PROTHEUS.dbo.Z01010 Z01010
		WHERE 
			Z01010.Z01_CODGER = (Z22010.Z22_FILIAL + Z22010.Z22_ALMORI)
	) AS 'TIPO ORIGEM',
	
	Z22010.Z22_PRDORI AS 'PRODUTO',
	PRODUTO.DESCRICAO AS 'DESCRIÇÃO',
	Z22010.Z22_UM AS 'UND',
	Z22010.Z22_QUANT AS 'QTDE',
	PRODUTO.ULTIMO_PREÇO AS 'VAL UND',
	(Z22010.Z22_QUANT*PRODUTO.ULTIMO_PREÇO) AS 'VAL TOTAL',

	CASE
		WHEN Z22010.Z22_APROV<>'B'
			THEN NULL
		ELSE
			(
				SELECT 
					SB2010.B2_QATU AS 'QTD'
				FROM PROTHEUS.dbo.SB2010 SB2010
				WHERE 
					(SB2010.D_E_L_E_T_<>'*') AND
					(SB2010.B2_FILIAL=Z22010.Z22_FILIAL) AND
					(SB2010.B2_LOCAL=Z22010.Z22_ALMORI) AND
					(SB2010.B2_COD=Z22010.Z22_PRDORI)
			)
	END AS 'SALDO ESTOQUE',
	
	Z22010.Z22_FILIAL+Z22010.Z22_ALMDES+' - '+(
		SELECT
			Z01010.Z01_DESC AS Z01_DESC
		FROM PROTHEUS.dbo.Z01010 Z01010
		WHERE 
			Z01010.Z01_CODGER = (Z22010.Z22_FILIAL + Z22010.Z22_ALMDES)
	) AS 'ARMAZÉM DESTINO',
	
	(
		SELECT
			CASE WHEN Z01010.Z01_TME = '001' THEN 'ENDICON - MATERIAIS NOVOS' WHEN Z01010.Z01_TME = '002' THEN 'CLIENTE' WHEN Z01010.Z01_TME = '005' THEN 'ATIVO' WHEN Z01010.Z01_TME = '006' THEN 'ENDICON - MATERIAIS USADOS' ELSE 'ERRO' END AS 'TIPO ARMAZÉM'
		FROM PROTHEUS.dbo.Z01010 Z01010
		WHERE 
			Z01010.Z01_CODGER = (Z22010.Z22_FILIAL + Z22010.Z22_ALMDES)
	) AS 'TIPO DESTINO',
	
	IIF
	(
		(
			SELECT
				Z01010.Z01_TME
			FROM PROTHEUS.dbo.Z01010 Z01010
			WHERE 
				Z01010.Z01_CODGER = (Z22010.Z22_FILIAL + Z22010.Z22_ALMORI)
		) = (
			SELECT
				Z01010.Z01_TME
			FROM PROTHEUS.dbo.Z01010 Z01010
			WHERE 
				Z01010.Z01_CODGER = (Z22010.Z22_FILIAL + Z22010.Z22_ALMDES)
		),
		'VALIDADO',
		'ERRO: ARMAZÉNS DIFERENTES'
	) AS 'VALIDAÇÃO: ARMAZÉM',
	
	CASE WHEN Z22010.Z22_PRDORI<>Z22010.Z22_PRDDES THEN 'ERRO: PRODUTOS DIFERENTES' ELSE 'VALIDADO' END AS 'VALIDAÇÃO: PRODUTO',
	Case RTrim(Coalesce(Z22010.Z22_EMISSA,'')) WHEN ''  THEN Null ELSE convert(datetime, Z22010.Z22_EMISSA, 112)END AS 'DT EMISSÃO',
	PRODUTO.COD_GRUPO AS 'GRUPO',
	PRODUTO.DESC_GRUPO AS 'DESCRIÇÃO GRUPO',
	Z22010.Z22_CONTA AS 'C CONTÁBIL',
	RTRIM(CT1010.CT1_DESC01) AS 'DESC C CONTÁBIL', 
	Z22010.Z22_SD3DOC AS 'DOC GERADO (SD3)',
	CASE 
		WHEN Z22010.Z22_SD3DOC<>'         ' 
			THEN 'TRANSF. REALIZADA' 
		WHEN Z22010.Z22_SD3DOC='         ' AND Z22010.Z22_APROV='B'
			THEN 'PENDENTE'
		WHEN Z22010.Z22_SD3DOC='         ' AND Z22010.Z22_APROV='R'
			THEN 'REJEITADA'
		ELSE 'ERRO' 
	END AS 'STATUS',
	CASE Z22010.Z22_APROV WHEN 'B'  THEN 'BLOQUEADO' WHEN 'L'  THEN 'LIBERADO' WHEN 'R'  THEN 'REJEITADO'ELSE 'ERRO' END AS 'SITUAÇÃO',
	Z22010.Z22_CODUSR AS 'COD USUÁRIO',
	Z22010.Z22_USUARI AS 'SOLICITANTE TRANSFERÊNCIA',
	Z22010.Z22_HORA AS 'HORA',
	Z22010.Z22_ENVIAD AS 'ENVIADO',
		
	Z22010.Z22_APROV1 AS 'APROVADOR 1',
	Z22010.Z22_APROV2 AS 'APROVADOR 2',
	Z22010.Z22_APROV3 AS 'APROVADOR 3',
	Z22010.Z22_APROV4 AS 'APROVADOR 4',
	Z22010.Z22_APROV5 AS 'APROVADOR 5',
	Z22010.Z22_APROV6 AS 'APROVADOR 6',
	Z22010.Z22_APROV7 AS 'APROVADOR 7',

	Z22010.Z22_LIBOK1 AS 'LIBERADO 01',
	Z22010.Z22_LIBOK2 AS 'LIBERADO 02',
	Z22010.Z22_LIBOK3 AS 'LIBERADO 03',
	Z22010.Z22_LIBOK4 AS 'LIBERADO 04',
	Z22010.Z22_LIBOK5 AS 'LIBERADO 05',
	Z22010.Z22_LIBOK6 AS 'LIBERADO 06',
	Z22010.Z22_LIBOK7 AS 'LIBERADO 07',
	
	Case RTrim(Coalesce(Z22010.Z22_DTLIB1,'')) WHEN ''  THEN Null ELSE convert(datetime, Z22010.Z22_DTLIB1, 112)END AS 'DTLIB 01',
	Case RTrim(Coalesce(Z22010.Z22_DTLIB2,'')) WHEN ''  THEN Null ELSE convert(datetime, Z22010.Z22_DTLIB2, 112)END AS 'DTLIB 02',
	Case RTrim(Coalesce(Z22010.Z22_DTLIB3,'')) WHEN ''  THEN Null ELSE convert(datetime, Z22010.Z22_DTLIB3, 112)END AS 'DTLIB 03',
	Case RTrim(Coalesce(Z22010.Z22_DTLIB4,'')) WHEN ''  THEN Null ELSE convert(datetime, Z22010.Z22_DTLIB4, 112)END AS 'DTLIB 04',
	Case RTrim(Coalesce(Z22010.Z22_DTLIB5,'')) WHEN ''  THEN Null ELSE convert(datetime, Z22010.Z22_DTLIB5, 112)END AS 'DTLIB 05',
	Case RTrim(Coalesce(Z22010.Z22_DTLIB6,'')) WHEN ''  THEN Null ELSE convert(datetime, Z22010.Z22_DTLIB6, 112)END AS 'DTLIB 06',
	Case RTrim(Coalesce(Z22010.Z22_DTLIB7,'')) WHEN ''  THEN Null ELSE convert(datetime, Z22010.Z22_DTLIB7, 112)END AS 'DTLIB 07',
	
	CASE 
		WHEN Z22010.Z22_APROV='L' OR Z22010.Z22_APROV='R' 
			THEN DATEDIFF(DAY,Z22010.Z22_EMISSA, Z22010.Z22_DTLIB1) 
		ELSE DATEDIFF(DAY,Z22010.Z22_EMISSA, GETDATE()) 
	END AS 'TEMPO DECORRIDO'
	
FROM PROTHEUS.dbo.Z22010 Z22010
	LEFT JOIN PROTHEUS.dbo.CT1010 CT1010 ON Z22010.Z22_CONTA=CT1010.CT1_CONTA AND CT1010.D_E_L_E_T_ <> '*' 
	LEFT JOIN 
		(
			SELECT 
				SB1010.B1_COD AS CODIGO,
				SB1010.B1_DESC AS DESCRICAO,
				SB1010.B1_GRUPO AS COD_GRUPO,
				GRUPO.DESCRICAO_GRUPO AS DESC_GRUPO,
				SB1010.B1_UPRC AS ULTIMO_PREÇO
			FROM PROTHEUS.dbo.SB1010 SB1010
				LEFT JOIN 
					(
						SELECT 
							SBM010.BM_GRUPO AS CODIGO_GRUPO,
							SBM010.BM_DESC AS DESCRICAO_GRUPO
						FROM PROTHEUS.dbo.SBM010 SBM010
						WHERE
							(SBM010.D_E_L_E_T_<>'*')
					) AS GRUPO ON SB1010.B1_GRUPO=GRUPO.CODIGO_GRUPO
			WHERE
				(SB1010.D_E_L_E_T_<>'*')
		) AS PRODUTO ON Z22010.Z22_PRDORI=PRODUTO.CODIGO
WHERE
	(Z22010.D_E_L_E_T_ <>'*')
	/* -- APROVADORA MAYARA SILVA */
	AND
	(
		(Z22010.Z22_SD3DOC='         ') AND Z22010.Z22_APROV NOT IN ('R', 'L', 'X') AND 
		(
			(Z22010.Z22_LIBOK1<>'S' AND Z22010.Z22_APROV1='000048' AND Z22010.Z22_DTLIB1='') OR
			(Z22010.Z22_LIBOK1='S' AND Z22010.Z22_LIBOK2<>'S' AND Z22010.Z22_APROV2='000048' AND Z22010.Z22_DTLIB2='') OR
			(Z22010.Z22_LIBOK2='S' AND Z22010.Z22_LIBOK3<>'S' AND Z22010.Z22_APROV3='000048' AND Z22010.Z22_DTLIB3='') OR
			(Z22010.Z22_LIBOK3='S' AND Z22010.Z22_LIBOK4<>'S' AND Z22010.Z22_APROV4='000048' AND Z22010.Z22_DTLIB4='') OR
			(Z22010.Z22_LIBOK4='S' AND Z22010.Z22_LIBOK5<>'S' AND Z22010.Z22_APROV5='000048' AND Z22010.Z22_DTLIB5='') OR
			(Z22010.Z22_LIBOK5='S' AND Z22010.Z22_LIBOK6<>'S' AND Z22010.Z22_APROV6='000048' AND Z22010.Z22_DTLIB6='') OR
			(Z22010.Z22_LIBOK6='S' AND Z22010.Z22_LIBOK7<>'S' AND Z22010.Z22_APROV7='000048' AND Z22010.Z22_DTLIB7='')
		)
	)
ORDER BY
	Z22010.Z22_FILIAL,
	Z22010.Z22_ALMORI,
	Z22010.Z22_DOC,
	PRODUTO.COD_GRUPO,
	Z22010.Z22_PRDORI

/* QUERY RESUMO DE TRANSFS INTERN PENDENTES */

-- SELECT
	-- Z22_FILIAL+Z22_ALMORI+'->'+Z22_FILIAL+Z22_ALMDES AS DEPARA,
	-- Z22_DOC,
	-- Z22_PRDDES,
	-- DATEDIFF(DAY,Z22010.Z22_EMISSA, GETDATE())  AS DECORRIDO,
	-- COUNT(Z22_QUANT) AS CONTAGEM,
	-- SUM(Z22_QUANT) AS SOMA
-- FROM Z22010
-- WHERE
	-- Z22010.Z22_APROV = 'B' AND
	-- Z22010.D_E_L_E_T_<>'*'
-- GROUP BY
	-- Z22_FILIAL+Z22_ALMORI+'->'+Z22_FILIAL+Z22_ALMDES,
	-- Z22_DOC,
	-- Z22_PRDDES,
	-- DATEDIFF(DAY,Z22010.Z22_EMISSA, GETDATE())
-- ORDER BY
	-- DATEDIFF(DAY,Z22010.Z22_EMISSA, GETDATE()) DESC