SELECT 
	RTRIM(SB1010.B1_COD) AS 'CÓDIGO',
	SB1010.B1_CDGESTO AS 'COD GESTORCORP',
	SB1010.B1_SAPCB AS 'COD SAP MT',
	SB1010.B1_SAPCE AS 'COD SAP CE',
	RTRIM(SB1010.B1_DESC) AS 'DESCRIÇÃO',
	SB1010.B1_UM AS 'UN',
	
	SB1010.B1_TIPO+' - '+
	(
		SELECT SX5010.X5_DESCRI
		FROM PROTHEUS.dbo.SX5010 SX5010
		WHERE X5_TABELA='02' AND SX5010.X5_CHAVE=SB1010.B1_TIPO
	) AS 'DESCRIÇÃO TIPO DO PRODUTO',
	
	SB1010.B1_GRUPO+' - '+
	RTRIM(SBM010.BM_DESC) AS 'DESCRIÇÃO DO GRUPO',

	BM_TIPGRU+' - '+
	(
		SELECT SX5010.X5_DESCRI
		FROM PROTHEUS.dbo.SX5010 SX5010
		WHERE X5_TABELA='V0' AND SX5010.X5_CHAVE=BM_TIPGRU
	) AS 'DESCRIÇÃO TIPO DE GRUPO',
	
	SBM010.BM_GRUREL AS 'REL TIP GRUPOS',
	
	SB1010.B1_POSIPI+' - '+
	YD_DESC_P AS 'DESCRIÇÃO NCM',
	
	Case RTrim(Coalesce(SB1010.B1_UCOM,'')) WHEN ''  THEN Null ELSE convert(datetime, SB1010.B1_UCOM, 112)END AS 'ULT. COMPRA',
	Case RTrim(Coalesce(SB1010.B1_DTINCL,'')) WHEN ''  THEN Null ELSE convert(datetime, SB1010.B1_DTINCL, 112)END AS 'DT. INCLUSÃO',	
	SB1010.B1_REFFABR AS 'REF FABRICANTE',
	SB1010.B1_UPRC AS 'UPC',
	
	--CASE WHEN SB1010.B1_MSBLQL='2' THEN 'DESBLOQUEADO' ELSE 'BLOQUEADO' END AS 'SITUAÇÃO',
	
	CAST((
	SELECT MAX(SC7010.C7_EMISSAO)
	FROM PROTHEUS.dbo.SC7010 SC7010
	WHERE (SC7010.D_E_L_E_T_<>'*') AND (SC7010.C7_EMISSAO>'20140312') AND (SC7010.C7_CONAPRO='L') AND (SC7010.C7_QUJE>0) AND (SC7010.C7_RESIDUO<>'S') AND (SB1010.B1_COD=SC7010.C7_PRODUTO)
	) AS DATETIME) AS 'UC (RECALCULO)',
	
	(
		SELECT SUM(SC7010.C7_QUJE)
		FROM PROTHEUS.dbo.SC7010 SC7010
		WHERE (SC7010.D_E_L_E_T_<>'*') AND (SC7010.C7_EMISSAO>'20140312' AND SC7010.C7_EMISSAO<='20141231') AND (SC7010.C7_CONAPRO='L') AND (SC7010.C7_QUJE>0) AND (SC7010.C7_RESIDUO<>'S') AND (SB1010.B1_COD=SC7010.C7_PRODUTO)
	) AS 'COMPRA 2014',
	
	(
		SELECT SUM(SC7010.C7_QUJE)
		FROM PROTHEUS.dbo.SC7010 SC7010
		WHERE (SC7010.D_E_L_E_T_<>'*') AND (SC7010.C7_EMISSAO>='20150101' AND SC7010.C7_EMISSAO<='20151231') AND (SC7010.C7_CONAPRO='L') AND (SC7010.C7_QUJE>0) AND (SC7010.C7_RESIDUO<>'S') AND (SB1010.B1_COD=SC7010.C7_PRODUTO)
	) AS 'COMPRA 2015',
	
	(
		SELECT SUM(SC7010.C7_QUJE)
		FROM PROTHEUS.dbo.SC7010 SC7010
		WHERE (SC7010.D_E_L_E_T_<>'*') AND (SC7010.C7_EMISSAO>='20160101' AND SC7010.C7_EMISSAO<='20161231') AND (SC7010.C7_CONAPRO='L') AND (SC7010.C7_QUJE>0) AND (SC7010.C7_RESIDUO<>'S') AND (SB1010.B1_COD=SC7010.C7_PRODUTO)
	) AS 'COMPRA 2016',
	
	(
		SELECT SUM(SC7010.C7_QUJE)
		FROM PROTHEUS.dbo.SC7010 SC7010
		WHERE (SC7010.D_E_L_E_T_<>'*') AND (SC7010.C7_EMISSAO>='20170101' AND SC7010.C7_EMISSAO<='20171231') AND (SC7010.C7_CONAPRO='L') AND (SC7010.C7_QUJE>0) AND (SC7010.C7_RESIDUO<>'S') AND (SB1010.B1_COD=SC7010.C7_PRODUTO)
	) AS 'COMPRA 2017',
	
	CASE 
		WHEN 
			(
				SELECT SUM(SC7010.C7_QUJE)
				FROM PROTHEUS.dbo.SC7010 SC7010
				WHERE (SC7010.D_E_L_E_T_<>'*') AND (SC7010.C7_CONAPRO='L') AND ((SC7010.C7_QUJE+SC7010.C7_QTDACLA)>0) AND (SC7010.C7_RESIDUO<>'S') AND (SB1010.B1_COD=SC7010.C7_PRODUTO) AND (SC7010.C7_CC = '         ') AND
					(
						SC7010.C7_EMISSAO>=DATEADD(DAY,-730,GETDATE())  --EQUIVALENTE A DOIS ANOS
						AND SC7010.C7_EMISSAO<=GETDATE()
					) 
			)>0
			THEN 'SIM' 
		ELSE 'NÃO' 
	END AS 'ESTOCÁVEL?',
	
	(
		SELECT COUNT(SD1010.D1_COD) AS 'POPULARIDADE - ENTRADA'
		FROM PROTHEUS.dbo.SD1010 SD1010
			LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA
			LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON  SA2010.A2_COD=SD1010.D1_FORNECE
		WHERE 
			(SD1010.D_E_L_E_T_<>'*') AND
			(LEFT(SA2010.A2_CGC,8)<>'05061494') AND
			(
				SF1010.F1_DTDIGIT>=DATEADD(DAY,-730,GETDATE()) AND --EQUIVALENTE A DOIS ANOS
				SF1010.F1_DTDIGIT<=GETDATE()
			) AND
			SD1010.D1_COD=SB1010.B1_COD
	) AS 'POPULARIDADE - ENTRADA',
	
	(
		SELECT COUNT(SD3010.D3_COD) AS 'POPULARIDADE - SAÍDA'
		FROM PROTHEUS.dbo.SD3010 SD3010 
		WHERE
			(SD3010.D_E_L_E_T_<>'*') AND
			(LEFT(SD3010.D3_CF,2) = 'RE') AND
			(SD3010.D3_ESTORNO='') AND
			(SD3010.D3_DOC NOT LIKE '%INVENT%') AND
			(SD3010.D3_TM<>'999' AND SD3010.D3_TM<>'503' AND SD3010.D3_TM<>'504') AND
			(
				SD3010.D3_EMISSAO>=DATEADD(DAY,-730,GETDATE()) AND --EQUIVALENTE A DOIS ANOS
				SD3010.D3_EMISSAO<=GETDATE()
			) AND
			SD3010.D3_COD=SB1010.B1_COD
	) AS 'POPULARIDADE - SAÍDA'
	
FROM PROTHEUS.dbo.SB1010 SB1010
	LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO --TABELA DE GRUPO
	LEFT JOIN PROTHEUS.dbo.SYD010 SYD010 ON SYD010.YD_TEC=SB1010.B1_POSIPI --TABELA DE NCM
WHERE
	(SB1010.D_E_L_E_T_<>'*') 
	--AND SB1010.B1_MSBLQL='2'