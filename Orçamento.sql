/* APLICAÇÃO POR SA */

SELECT

  SD3010.D3_FILIAL AS 'FILIAL',
  SD3010.D3_LOCAL AS 'ARMAZÉM',
  REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ') AS 'REGIONAL',
  REPLACE(RTRIM(CTT010.CTT_DESC01),'  ',' ') AS 'CENTRO DE CUSTO',
  'ESTOQUE' AS 'TIPO',
  CASE
    WHEN SD3010.D3_CLVL = '001      ' OR SD3010.D3_TM = '505' THEN 'INVESTIMENTO'
    WHEN CTT010.CTT_TPCC = 'C' THEN 'DESPESA'
    WHEN CTT010.CTT_TPCC = 'O' OR SD3010.D3_TM <> '505' THEN 'CUSTO'

  ELSE 'ERRO' END AS 'DESEMBOLSO',

  LEFT(SD3010.D3_EMISSAO,4)+' - '+SUBSTRING(SD3010.D3_EMISSAO,5,2) AS 'ANO-MÊS',
  CAST((SB1010.B1_UPRC*SD3010.D3_QUANT)*-1 AS MONEY) AS 'VALOR', --VALOR UPC
  'REALIZADO' AS 'ORÇ X REAL',

  CASE
    WHEN SD3010.D3_CONTA='                    ' OR SD3010.D3_TM = '505' THEN 'ATIVO'
    ELSE RTRIM(CT1010.CT1_DESC01)
  END AS 'CONTA CONTÁBIL',
  RTRIM(SCQ010.CQ_NUM) AS 'SA / PC',
  RTRIM(SCQ010.CQ_ITEM) AS 'ITEM',
  SD3010.D3_FILIAL+SD3010.D3_LOCAL AS 'FILIAL-ARMAZEM',
  SD3010.D3_DOC AS 'NUM DOCUMENTO',
  SD3010.D3_USUARIO AS 'ALMOXARIFE',

  'SA: '+RTRIM(SCQ010.CQ_NUM)+' | '+'ITEM: '+RTRIM(SCQ010.CQ_ITEM)+' | '+'LOCAL: '+SD3010.D3_FILIAL+SD3010.D3_LOCAL+' | '+'RM: '+SD3010.D3_DOC +' | '+'ALMOXARIFE: '+SD3010.D3_USUARIO AS 'DETALHE'
FROM PROTHEUS.dbo.SD3010 SD3010
  LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*' --LINK PRODUTOS
  LEFT JOIN PROTHEUS.dbo.CTT010 CTT010 ON SD3010.D3_CC=CTT010.CTT_CUSTO AND CTT010.D_E_L_E_T_ <> '*' --LINK CENTRO DE CUSTO
  LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*'  --LINK ARMAZÉM
  LEFT JOIN PROTHEUS.dbo.CT1010 CT1010 ON SD3010.D3_CONTA=CT1010.CT1_CONTA AND CT1010.D_E_L_E_T_ <> '*' --CONTA CONTÁBIL
  --DADOS DE SA
	LEFT JOIN PROTHEUS.dbo.SCQ010 SCQ010 ON SD3010.D3_NUMSEQ=SCQ010.CQ_NUMREQ AND SD3010.D3_FILIAL=SCQ010.CQ_FILIAL AND SD3010.D3_LOCAL=SCQ010.CQ_LOCAL
	LEFT JOIN PROTHEUS.dbo.SCP010 SCP010 ON SCP010.CP_NUM+SCP010.CP_ITEM=SCQ010.CQ_NUM+SCQ010.CQ_ITEM AND SCP010.CP_FILIAL=SCQ010.CQ_FILIAL AND SCP010.CP_LOCAL=SCQ010.CQ_LOCAL
	LEFT JOIN PROTHEUS.dbo.SA2010 FUNCIONARIO ON  FUNCIONARIO.A2_COD=SCP010.CP_FORNECE
WHERE
  (SD3010.D_E_L_E_T_<>'*') AND
	(LEFT(SD3010.D3_CF,2) = 'RE') AND --SOMENTE SAÍDA
	(SD3010.D3_ESTORNO='') AND --DESCONSIDERA ESTORNO
	((SD3010.D3_DOC NOT LIKE '%INVENT%') AND (SD3010.D3_TM<>'503')) AND --DESCONSIDERA REGULARIZAÇÕES DE INVENTÁRIO
	(SD3010.D3_TM <> '999') AND --DESCONSIDERA TRANSFERÊNCIA
	(SD3010.D3_TM<>'504') AND --DESCONSIDERA OUTROS MOVIMENTOS
	(SD3010.D3_EMISSAO>='20170101') AND (SD3010.D3_EMISSAO<='20171231') AND --FIXAR PERÍODO
  (Z01010.Z01_TME = '001') AND--SOMENTE ARMAZÉNS ENDICON
--   (Z01010.Z01_MSBLQL = '2') --AND --SOMENTE ARMAZÉNS DESBLOQUEADOS
--   (SD3010.D3_CONTA IN ('3130104','3130102','3130101','3130103'))--FILTRO DE CONTA CONTÁBIL
  (CTT010.CTT_CLASSE = '2') AND --SOMENTE CC ANALÍTICO
--REMOVENDO CC NÃO UTILIZADOS EM 2018
  (CTT010.CTT_CUSTO NOT IN ('0072505','0073005','0073105','0073110','0073140','0073152','0073153','0073252','0073253','0073305','0073310','0073405','007340913','0073410','0073436','0073440','0073447','0073452','0073453','0073460','0073461','0073462','0073463','0073464','0073465','0073505','007351316','0073604','0073605','0073610','007361316','007361418','0073630','0073632','0073633','0073635','0073636','0073640','0073642','0073645','0073646','0073647','0073649','0073650','0073651','0073652','0073653','0073658','0073659','0073660','0073661','0073662','0073663','0073664','0073665','007360561','0085905','0086035','0107405','0107461','0107463','0107465','0107563','0109205','0109233','0109234','0109235','0109236','0109243','0109247','0109259','0109263','0109265','0107410','0130436','0020236'))

Union all

  /* DEVOLUÇÃO POR SA */

SELECT

  SD3010.D3_FILIAL AS 'FILIAL',
  SD3010.D3_LOCAL AS 'ARMAZÉM',
  REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ') AS 'REGIONAL',
  REPLACE(RTRIM(CTT010.CTT_DESC01),'  ',' ') AS 'CENTRO DE CUSTO',
  'ESTOQUE' AS 'TIPO',
  CASE
    WHEN SD3010.D3_CLVL = '001      ' OR SD3010.D3_TM = '505' THEN 'INVESTIMENTO'
    WHEN CTT010.CTT_TPCC = 'C' THEN 'DESPESA'
    WHEN CTT010.CTT_TPCC = 'O' OR SD3010.D3_TM <> '505' THEN 'CUSTO'
  ELSE 'ERRO' END AS 'DESEMBOLSO',

  LEFT(SD3010.D3_EMISSAO,4)+' - '+SUBSTRING(SD3010.D3_EMISSAO,5,2) AS 'ANO-MÊS',
  CAST((SB1010.B1_UPRC*SD3010.D3_QUANT) AS MONEY) AS 'VALOR', --VALOR UPC
  'REALIZADO' AS 'ORÇ X REAL',

  CASE
    WHEN SD3010.D3_CONTA='                    ' THEN 'ATIVO'
    ELSE RTRIM(CT1010.CT1_DESC01)
  END AS 'CONTA CONTÁBIL',
  RTRIM(SCQ010.CQ_NUM) AS 'SA / PC',
  RTRIM(SCQ010.CQ_ITEM) AS 'ITEM',
  SD3010.D3_FILIAL+SD3010.D3_LOCAL AS 'FILIAL-ARMAZEM',
  SD3010.D3_DOC AS 'NUM DOCUMENTO',
  SD3010.D3_USUARIO AS 'ALMOXARIFE',

  'SA: '+RTRIM(SCQ010.CQ_NUM)+' | '+'ITEM: '+RTRIM(SCQ010.CQ_ITEM)+' | '+'LOCAL: '+SD3010.D3_FILIAL+SD3010.D3_LOCAL+' | '+'RM: '+SD3010.D3_DOC +' | '+'ALMOXARIFE: '+SD3010.D3_USUARIO AS 'DETALHE'
FROM PROTHEUS.dbo.SD3010 SD3010
  LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*' --LINK PRODUTOS
  LEFT JOIN PROTHEUS.dbo.CTT010 CTT010 ON SD3010.D3_CC=CTT010.CTT_CUSTO AND CTT010.D_E_L_E_T_ <> '*' --LINK CENTRO DE CUSTO
  LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*'  --LINK ARMAZÉM
  LEFT JOIN PROTHEUS.dbo.CT1010 CT1010 ON SD3010.D3_CONTA=CT1010.CT1_CONTA AND CT1010.D_E_L_E_T_ <> '*' --CONTA CONTÁBIL
  --DADOS DE SA
	LEFT JOIN PROTHEUS.dbo.SCQ010 SCQ010 ON SD3010.D3_NUMSEQ=SCQ010.CQ_NUMREQ AND SD3010.D3_FILIAL=SCQ010.CQ_FILIAL AND SD3010.D3_LOCAL=SCQ010.CQ_LOCAL
	LEFT JOIN PROTHEUS.dbo.SCP010 SCP010 ON SCP010.CP_NUM+SCP010.CP_ITEM=SCQ010.CQ_NUM+SCQ010.CQ_ITEM AND SCP010.CP_FILIAL=SCQ010.CQ_FILIAL AND SCP010.CP_LOCAL=SCQ010.CQ_LOCAL
	LEFT JOIN PROTHEUS.dbo.SA2010 FUNCIONARIO ON  FUNCIONARIO.A2_COD=SCP010.CP_FORNECE
WHERE
  (SD3010.D_E_L_E_T_<>'*') AND
	(LEFT(SD3010.D3_CF,2) = 'DE') AND --SOMENTE DEVOLUÇÃO
	(SD3010.D3_ESTORNO='') AND --DESCONSIDERA ESTORNO
	((SD3010.D3_DOC NOT LIKE '%INVENT%') AND (SD3010.D3_TM<>'003')) AND --DESCONSIDERA REGULARIZAÇÕES DE INVENTÁRIO
	(SD3010.D3_TM <> '499') AND --DESCONSIDERA TRANSFERÊNCIA
	(SD3010.D3_TM<>'004') AND --DESCONSIDERA OUTROS MOVIMENTOS
	(SD3010.D3_EMISSAO>='20170101') AND (SD3010.D3_EMISSAO<='20171231') AND --FIXAR PERÍODO
  (Z01010.Z01_TME = '001') AND--SOMENTE ARMAZÉNS ENDICON
--   (Z01010.Z01_MSBLQL = '2') AND --SOMENTE ARMAZÉNS DESBLOQUEADOS
--   (SD3010.D3_CONTA IN ('3130104','3130102','3130101','3130103'))--FILTRO DE CONTA CONTÁBIL
  (CTT010.CTT_CLASSE = '2') AND --SOMENTE CC ANALÍTICO
 --REMOVENDO CC NÃO UTILIZADOS EM 2018
  (CTT010.CTT_CUSTO NOT IN ('0072505','0073005','0073105','0073110','0073140','0073152','0073153','0073252','0073253','0073305','0073310','0073405','007340913','0073410','0073436','0073440','0073447','0073452','0073453','0073460','0073461','0073462','0073463','0073464','0073465','0073505','007351316','0073604','0073605','0073610','007361316','007361418','0073630','0073632','0073633','0073635','0073636','0073640','0073642','0073645','0073646','0073647','0073649','0073650','0073651','0073652','0073653','0073658','0073659','0073660','0073661','0073662','0073663','0073664','0073665','007360561','0085905','0086035','0107405','0107461','0107463','0107465','0107563','0109205','0109233','0109234','0109235','0109236','0109243','0109247','0109259','0109263','0109265','0107410','0130436','0020236'))

Union all

--COMPRA APLICAÇÃO DIRETA

SELECT

  SD1010.D1_FILIAL AS 'FILIAL',
	SD1010.D1_LOCAL AS 'LOCAL',
  REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ') AS 'REGIONAL',
  REPLACE(RTRIM(CTT010.CTT_DESC01),'  ',' ') AS 'CENTRO DE CUSTO',
  'APLICAÇÃO DIRETA' AS 'TIPO',
  CASE
    WHEN RTRIM(SD1010.D1_CLVL)='001' OR (SF4010.F4_ESTOQUE = 'N' AND SF4010.F4_ATUATF = 'S') THEN 'INVESTIMENTO'
    WHEN CTT010.CTT_TPCC = 'C' THEN 'DESPESA'
    WHEN CTT010.CTT_TPCC = 'O' OR SF4010.F4_ATUATF <> 'S' THEN 'CUSTO'
  ELSE 'ERRO' END AS 'DESEMBOLSO',

  LEFT(SF1010.F1_DTDIGIT,4)+' - '+SUBSTRING(SF1010.F1_DTDIGIT,5,2) AS 'ANO-MÊS',
  CAST((SB1010.B1_UPRC*SD1010.D1_QUANT)*-1 AS MONEY) AS 'VALOR', --VALOR UPC
  'REALIZADO' AS 'ORÇ X REAL',
 -- SD1010.D1_CONTA AS 'CONTA CONTABIL',

  CASE
    WHEN SD1010.D1_CONTA='                    ' THEN 'ATIVO'
    ELSE RTRIM(CT1010.CT1_DESC01)
  END AS 'CONTA CONTÁBIL',

  RTRIM(SD1010.D1_PEDIDO) AS 'SA / PC',
  RTRIM(SD1010.D1_ITEMPC) AS 'ITEM',
  SD1010.D1_FILIAL+SD1010.D1_LOCAL AS 'FILIAL-ARMAZEM',
  SD1010.D1_DOC AS 'NUM DOCUMENTO',
  SF1010.F1_NMUSER AS 'ALMOXARIFE',

  'PC: '+RTRIM(SD1010.D1_PEDIDO)+' | '+'ITEM: '+RTRIM(SD1010.D1_ITEMPC)+' | '+'LOCAL: '+SD1010.D1_FILIAL+SD1010.D1_LOCAL+' | '+'DOCUMENTO: '+SD1010.D1_DOC +' | '+'INC PRE-NOTA: '+SF1010.F1_NMUSER AS 'DETALHE'

FROM PROTHEUS.dbo.SD1010 SD1010
  LEFT JOIN PROTHEUS.dbo.CTT010 CTT010 ON SD1010.D1_CC=CTT_CUSTO
  LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA
  LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD1010.D1_COD=SB1010.B1_COD
  LEFT JOIN PROTHEUS.dbo.CT1010 CT1010 ON SD1010.D1_CONTA=CT1010.CT1_CONTA AND CT1010.D_E_L_E_T_ <> '*' --CONTA CONTÁBIL
  LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD1010.D1_TES
  LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON (SD1010.D1_FILIAL+SD1010.D1_LOCAL) = Z01010.Z01_CODGER
  LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON SA2010.A2_COD=SF1010.F1_FORNECE

WHERE
	(SD1010.D1_CC <> '         ') AND -- para aplicação direta
	(SD1010.D_E_L_E_T_<>'*') AND -- retira excluído excluído
	(SD1010.D1_TES<>'   ') AND -- retira não classificados
	(
		(SF4010.F4_TEXTO NOT LIKE '%*%') AND -- retira importação 1
		(SF1010.F1_ESPECIE <> 'SPE  ' OR SF1010.F1_ESPECIE <> 'SPE') AND -- retira importação 2
		(SF1010.F1_ESPECIE NOT LIKE 'NFE') -- retira importação 3
	) AND
	(
		LEFT(SA2010.A2_CGC,8)<>'05061494' AND -- ENDICON
		SA2010.A2_CGC<>'07047251000170' -- COELCE
	) AND -- RETIRA TRANSFERÊNCIA
	(SF1010.F1_DTDIGIT>='20170101' AND SF1010.F1_DTDIGIT<='20181231') AND -- fixa período
	(SD1010.D1_GRUPO NOT IN ('4005','4004','4006','4009','4010','0176','4007','0176','0171')) AND -- retira grupo
	(SD1010.D1_COD NOT IN ('00525957','00526672','00528766','01320532','01321108','02500159','02520001','02550387','02570001','40030015','40030018','40030019','40070086','40070065','01730062','02550337','02550286')) AND -- retira produto
	--(SD1010.D1_TES NOT IN ('417','451')) AND--retira TES de transf e cliente
  (SD1010.D1_CONTA IN ('3130104','3130102','3130101','3130103')) AND--FILTRO DE CONTA CONTÁBIL
  (Z01010.Z01_TME = '001') AND --SOMENTE ARMAZÉNS ENDICON
  --(Z01010.Z01_MSBLQL = '2') AND --SOMENTE ARMAZÉNS DESBLOQUEADOS
  (SF1010.F1_DTDIGIT>='20170101' AND SF1010.F1_DTDIGIT<='20171231') AND
  (CTT010.CTT_CLASSE = '2') AND --SOMENTE CC ANALÍTICO
  --REMOVENDO CC NÃO UTILIZADOS EM 2018
  (CTT010.CTT_CUSTO NOT IN ('0072505','0073005','0073105','0073110','0073140','0073152','0073153','0073252','0073253','0073305','0073310','0073405','007340913','0073410','0073436','0073440','0073447','0073452','0073453','0073460','0073461','0073462','0073463','0073464','0073465','0073505','007351316','0073604','0073605','0073610','007361316','007361418','0073630','0073632','0073633','0073635','0073636','0073640','0073642','0073645','0073646','0073647','0073649','0073650','0073651','0073652','0073653','0073658','0073659','0073660','0073661','0073662','0073663','0073664','0073665','007360561','0085905','0086035','0107405','0107461','0107463','0107465','0107563','0109205','0109233','0109234','0109235','0109236','0109243','0109247','0109259','0109263','0109265','0107410','0130436','0020236'))

