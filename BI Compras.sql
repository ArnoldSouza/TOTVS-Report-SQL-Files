SELECT
    CONCAT(SC7010.C7_FILIAL, IIF(SC7010.C7_XLOCENT='  ',SC1010.C1_LOCAL,SC7010.C7_XLOCENT)) AS 'LOCAL ORIGEM',
    CONCAT(SC7010.C7_FILENT,SC7010.C7_LOCAL) AS 'LOCAL ENTREGA',

	-- CORRIGE A APROPRIAÇÃO DA FILIAL PARA O PROCESSO
	CASE WHEN CONCAT(SC7010.C7_FILENT,SC7010.C7_LOCAL) IN ('0240','0245')
		THEN CONCAT(SC7010.C7_FILIAL, IIF(SC7010.C7_XLOCENT='  ',SC1010.C1_LOCAL,SC7010.C7_XLOCENT))
		ELSE CONCAT(SC7010.C7_FILENT,SC7010.C7_LOCAL)
	END AS 'LOCAL CORRIGIDO',

    -->>OPCAO 1<<--
    SC7010.C7_FILIAL AS 'FILIAL 1', --ORIGINAL DA SC7
	SC7010.C7_LOCAL AS 'LOCAL 1', --ORIGINAL DA SC7

    -->>OPCAO 2<<--
    SC7010.C7_FILENT AS 'FILIAL 2', --REPETIDO NA TABELA
	SC1010.C1_LOCAL AS 'LOCAL 2', --VEIO DA TABELA DE SC1

    -->>OPCAO 3<<--
    SC7010.C7_XFILENT AS 'FILIAL 3', --REGISTA A FILIAL ANTERIOR
    SC7010.C7_XLOCENT AS 'LOCAL 3', --REGISTA O LOCAL ANTERIOR

    -->>OPCAO 4<<--
    SC1010.C1_FILIAL AS 'SC: FIL', --RETIRADO DA TABELA DE SC
	SC1010.C1_LOCAL AS 'SC: LOC', --RETIRADO DA TABELA DE SC

    -- IDENTIFICA PROCESSO
    SC7010.C7_NUM AS 'NUM PC',
    SC7010.C7_ITEM AS 'ITEM',
    SC7010.C7_NUMSC AS 'NUM SC',
    SC7010.C7_ITEMSC AS 'ITEM SC',

    --DETALHES DE VALOR E PRODUTO
    RTRIM(SC7010.C7_PRODUTO) AS 'CODIGO',
    RTRIM(SC7010.C7_DESCRI) AS 'DESCRIÇÃO',
    SC7010.C7_QUANT AS 'QTDE',
    SC7010.C7_PRECO AS 'VAL UND',
    SC7010.C7_TOTAL AS 'VAL MERCADORIA',
    RTRIM(SC7010.C7_OBS) AS 'OBSERVAÇÃO',

    --ACOMPANHAMENTO DE COMPRA/ENTREGA
    SC7010.C7_QUJE AS 'QTDE ENTREGUE',
    SC7010.C7_QTDACLA AS 'QTDE A CLASSI',

    -- SITUAÇÃO DO PROCESSO
    CASE WHEN SC7010.C7_CONAPRO = 'L' THEN 'APROVADO' ELSE 'BLOQUEADO' END AS 'SITUAÇÃO PC',
    CASE
        WHEN (SC7010.C7_QUJE+SC7010.C7_QTDACLA)=SC7010.C7_QUANT THEN 'RECEBIDO TOTALMENTE'
        WHEN (SC7010.C7_QUJE+SC7010.C7_QTDACLA)=0 THEN 'FALTA RECEBER'
        WHEN (SC7010.C7_QUJE+SC7010.C7_QTDACLA)<SC7010.C7_QUANT AND (SC7010.C7_QUJE+SC7010.C7_QTDACLA)>0 THEN 'RECEBIDO PARCIAL'
        ELSE 'ERRO'
    END AS 'SITUAÇÃO DO PC',
    CASE WHEN SC7010.C7_TPCOMPR=2 THEN 'AP DIRETA' WHEN SC7010.C7_TPCOMPR=1 THEN 'ESTOQUE' ELSE 'ERRO' END AS 'TIPO DE COMPRA',
    CASE WHEN SC7010.C7_ENCER='E' THEN 'ENCERRADO' ELSE 'ABERTO' END AS 'PC ENCERRADO',
    CASE WHEN SC7010.C7_RESIDUO='S' THEN 'SIM' ELSE 'NÃO' END AS 'RESIDUO?',
    RTRIM(SC7010.C7_STEND) AS 'STATUS DO PC',

    --RESPONSÁVEL PELO PROCESSO
    SC7010.C7_USER AS 'COD COMPRADOR',

    --ESPECIFICA FORNECEDOR
    SC7010.C7_FORNECE AS 'FORNECEDOR',

    --CLASSIFICADORES
    SB1010.B1_GRUPO AS 'COD GRUPO',
    RTRIM(SC7010.C7_CC) AS 'CENTRO DE  CUSTO',
    RTRIM(SC7010.C7_CLVL) AS 'OBRA',
	RTRIM(SC7010.C7_CONTA) AS 'CONTA CONTÁBIL',

    --DATAS DO PROCESSO
    Case RTrim(Coalesce(SC7010.C7_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(DATETIME, SC7010.C7_EMISSAO, 112)END AS 'DT EMISSÃO PC',
    Case RTrim(Coalesce(SC7010.C7_ALTDATA,'')) WHEN ''  THEN Null ELSE convert(DATETIME, SC7010.C7_ALTDATA, 112)END AS 'DT ALTERADO PC',

    --DATAS ALTERNATIVAS
    Case RTrim(Coalesce(SC7010.C7_DTENTRA,'')) WHEN ''  THEN Null ELSE convert(DATETIME, SC7010.C7_DTENTRA, 112)END AS 'DT ENTRA NF', --É AUTOMÁTICO, DATA DE CONTABILIZAÇÃO DA NF

    --DATA DE APROVAÇÃO
    CONVERT(DATETIME,
        (
            SELECT MAX(LastUpdateDate)
            FROM (VALUES (SC7010.C7_DTLIB1),(SC7010.C7_DTLIB2),(SC7010.C7_DTLIB3),(SC7010.C7_DTLIB4),(SC7010.C7_DTLIB5),(SC7010.C7_DTLIB6),(SC7010.C7_DTLIB7), (SC7010.C7_EMISSAO), (SC7010.C7_ALTDATA)) AS UpdateDate(LastUpdateDate)
        )
    , 112) AS 'DT APROVAÇÃO PC',

    --TEMPO ATÉ APROVAR PROCESSO
    DATEDIFF(DAY,
        CONVERT(DATETIME, IIF(SC7010.C7_ALTDATA>SC7010.C7_EMISSAO, SC7010.C7_ALTDATA, SC7010.C7_EMISSAO), 112),
        CONVERT(
           DATETIME,
               (
                    SELECT MAX(LastUpdateDate)
                    FROM (VALUES (SC7010.C7_DTLIB1),(SC7010.C7_DTLIB2),(SC7010.C7_DTLIB3),(SC7010.C7_DTLIB4),(SC7010.C7_DTLIB5),(SC7010.C7_DTLIB6),(SC7010.C7_DTLIB7), (SC7010.C7_EMISSAO), (SC7010.C7_ALTDATA)) AS UpdateDate(LastUpdateDate)
                )
        )
    ) AS 'TEMPO APROVA PC',

    --CONDIÇÃO DE PAGAMENTO
    SC7010.C7_COND AS 'COND PAG',
	CASE WHEN SC7010.C7_ALTUSR='' THEN 'NÃO' ELSE 'SIM' END AS 'PC ALTERADO?',

	Case RTrim(Coalesce(SF1010.F1_RECBMTO,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_RECBMTO, 112)END AS 'DT RECEBIMENTO',

    --***************************************--
    --*** DADOS DE SOLICITAÇÃO DE COMPRAS ***--
    --***************************************--
	SC1010.C1_QUANT AS 'SC: QTDE',
	SC1010.C1_VLESTIM AS 'SC: VAL UND',
	SC1010.C1_VTOTAL AS 'SC: VAL TOTAL',
	--SC: DATA DE APROVAÇÃO
	CONVERT(DATETIME,
		(
			SELECT MAX(LastUpdateDate)
			FROM (VALUES (SC1010.C1_DTLIB1),(SC1010.C1_DTLIB2),(SC1010.C1_DTLIB3),(SC1010.C1_DTLIB4),(SC1010.C1_DTLIB5),(SC1010.C1_DTLIB6),(SC1010.C1_DTLIB7), (SC1010.C1_EMISSAO), (SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate)
		)
	, 112) AS 'DT APROVAÇÃO SC',
	--SC: TEMPO ATÉ APROVAR PROCESSO
	DATEDIFF(DAY,
		CONVERT(DATETIME, IIF(SC1010.C1_ALTDATA>SC1010.C1_EMISSAO, SC1010.C1_ALTDATA, SC1010.C1_EMISSAO), 112),
		CONVERT(
			DATETIME,
				(
					SELECT MAX(LastUpdateDate)
					FROM (VALUES (SC1010.C1_DTLIB1),(SC1010.C1_DTLIB2),(SC1010.C1_DTLIB3),(SC1010.C1_DTLIB4),(SC1010.C1_DTLIB5),(SC1010.C1_DTLIB6),(SC1010.C1_DTLIB7), (SC1010.C1_EMISSAO), (SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate)
				)
		)
	) AS 'TEMPO APROVA SC'

FROM PROTHEUS.dbo.SC7010 SC7010 WITH (NOLOCK)
    LEFT JOIN PROTHEUS.dbo.SB1010 SB1010  WITH (NOLOCK) ON SC7010.C7_PRODUTO=SB1010.B1_COD AND SB1010.D_E_L_E_T_<>'*'
    --CONEXÃO COM TABELA DE COMPRAS (SC1)
	LEFT JOIN PROTHEUS.dbo.SC1010 SC1010 WITH (NOLOCK) ON
		(SC1010.C1_NUM = SC7010.C7_NUMSC) --ASSOCIA SC COM PC
		AND (SC1010.C1_ITEM = SC7010.C7_ITEMSC) --ASSOCIA SC COM PC
		AND (SC1010.C1_EMISSAO>=CONCAT(YEAR(GETDATE())-2,'0101') AND SC1010.C1_EMISSAO<=GETDATE()) --BUSCA NO MAXIMO 2 ANOS DE SC
		AND (SC1010.D_E_L_E_T_<>'*') --DESCONSIDERA DELETADOS
		AND (SC1010.C1_QUJE>0) --SOMENTE SCS COM PC
		AND (SC1010.C1_PEDIDO<>'') --SOMENTE SCS COM PC
		AND (SC1010.C1_ITEMPED<>'') --SOMENTE SCS COM PC
        AND (SC1010.C1_RESIDUO = ' ') --SOMENTE SCS NAO ELIM POR RESIDUO
        AND (SC1010.C1_APROV = 'L') --SOMENTE SCS APROVADAS
	LEFT JOIN PROTHEUS.dbo.SD1010 SD1010 WITH (NOLOCK) ON SD1010.D1_PEDIDO=SC7010.C7_NUM AND SD1010.D1_ITEMPC=SC7010.C7_ITEM AND SC7010.D_E_L_E_T_<>'*'
		LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 WITH (NOLOCK) ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA AND SF1010.D_E_L_E_T_<>'*'
WHERE
    (SC7010.C7_EMISSAO>=CONCAT(YEAR(GETDATE())-1,'0101') AND SC7010.C7_EMISSAO<=GETDATE()) AND -- RESTRINGE INTERVALO DE TEMPO
    (SC7010.D_E_L_E_T_<>'*') --DESCONSIDERA DELETADOS
    AND (SC7010.C7_RESIDUO<>'S') --DESCONSIDERA ELIMINADO POR RESÍDUO
	AND SC7010.C7_NUMSC<>'' --DESCONSIDERA PC'S EMITIDOS SEM NUM DE SC ALOCADO (COMPRAS SEM SC)
	--AND SC1010.C1_FILIAL IS NOT NULL --TODO: DESCOMENTAR ESTA PARTE PARA COMPLETAR A QUERY
--ORDER BY
--	SC7010.R_E_C_N_O_ DESC