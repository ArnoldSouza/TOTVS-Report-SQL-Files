SELECT
	--IDENTIFICA LOCAL CASO TENHA CENTRO DE CUSTO
	ISNULL(REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' '),
		CASE
			WHEN SC1010.C1_FILIAL = '02' AND SC1010.C1_LOCAL = '22'	THEN 'IP BELEM'
			WHEN SC1010.C1_FILIAL = '07' AND SC1010.C1_LOCAL = '40'	THEN 'AMPLA'
			WHEN SC1010.C1_FILIAL = '12' AND SC1010.C1_LOCAL = '92'	THEN 'IP SANTAREM'
			WHEN SC1010.C1_FILIAL = '13' AND SC1010.C1_LOCAL = '95'	THEN 'COELBA'
			WHEN SC1010.C1_FILIAL = '09' AND SC1010.C1_LOCAL = '63'	THEN 'COELCE'
			WHEN SC1010.C1_FILIAL = '02' AND SC1010.C1_LOCAL = '11'	THEN 'BENGUI'
			WHEN SC1010.C1_FILIAL = '13' AND SC1010.C1_LOCAL = '03'	THEN 'COELBA'
			WHEN SC1010.C1_FILIAL = '02' AND SC1010.C1_LOCAL = '16'	THEN 'BENGUI'
			WHEN SC1010.C1_FILIAL = '12' AND SC1010.C1_LOCAL = '91'	THEN 'IP SANTAREM'
			WHEN SC1010.C1_FILIAL = '12' AND SC1010.C1_LOCAL = '90'	THEN 'CELPA CENTRO OESTE'
			WHEN SC1010.C1_FILIAL = '02' AND SC1010.C1_LOCAL = '01'	THEN 'BENGUI'
			WHEN SC1010.C1_FILIAL = '02' AND SC1010.C1_LOCAL = '21'	THEN 'IP BELEM'
			WHEN SC1010.C1_FILIAL = '02' AND SC1010.C1_LOCAL = '39'	THEN 'IP BELEM'
			WHEN SC1010.C1_FILIAL = '12' AND SC1010.C1_LOCAL = '94'	THEN 'CELPA OESTE'
			WHEN SC1010.C1_FILIAL = '02' AND SC1010.C1_LOCAL = '25'	THEN 'CELPA NORDESTE'
			WHEN SC1010.C1_FILIAL = '10' AND SC1010.C1_LOCAL = '03'	THEN 'CELG'
			WHEN SC1010.C1_FILIAL = '13' AND SC1010.C1_LOCAL = '96'	THEN 'COELBA'
			WHEN SC1010.C1_FILIAL = '13' AND SC1010.C1_LOCAL = '05'	THEN 'COELBA'
			WHEN SC1010.C1_FILIAL = '02' AND SC1010.C1_LOCAL = '18'	THEN 'CELPA NORDESTE'
			WHEN SC1010.C1_FILIAL = '12' AND SC1010.C1_LOCAL = '89'	THEN 'IP SANTAREM'
			WHEN SC1010.C1_FILIAL = '13' AND SC1010.C1_LOCAL = '04'	THEN 'COELBA'
			WHEN SC1010.C1_FILIAL = '09' AND SC1010.C1_LOCAL = '75'	THEN 'COELCE'
			WHEN SC1010.C1_FILIAL = '09' AND SC1010.C1_LOCAL = '65'	THEN 'COELCE'
			WHEN SC1010.C1_FILIAL = '09' AND SC1010.C1_LOCAL = '82'	THEN 'COELCE'
			WHEN SC1010.C1_FILIAL = '10' AND SC1010.C1_LOCAL = '04'	THEN 'CELG'
			WHEN SC1010.C1_FILIAL = '07' AND SC1010.C1_LOCAL = '43'	THEN 'AMPLA'
			WHEN SC1010.C1_FILIAL = '07' AND SC1010.C1_LOCAL = '53'	THEN 'AMPLA'
			WHEN SC1010.C1_FILIAL = '09' AND SC1010.C1_LOCAL = '59'	THEN 'COELCE'
			WHEN SC1010.C1_FILIAL = '09' AND SC1010.C1_LOCAL = '40'	THEN 'COELCE'
			WHEN SC1010.C1_FILIAL = '09' AND SC1010.C1_LOCAL = '30'	THEN 'COELCE'
			WHEN SC1010.C1_FILIAL = '07' AND SC1010.C1_LOCAL = '55'	THEN 'AMPLA'
			ELSE 'ERRO'
		END
	) AS 'REGIONAL',
	
	ISNULL(IIF(
		REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', '')=REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' '),
		REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', ''),
		REPLACE(REPLACE(REPLACE(RTRIM(CTT_XPOLO),'_',' '),'POLO ', ''), REPLACE(RTRIM(CTT010.CTT_XREGIO),'_',' ')+' ', '')
	),'ESTOQUE') AS 'POLO',
	
	SD1010.D1_FILIAL AS 'FILIAL',
	SD1010.D1_LOCAL AS 'LOCAL',
	SD1010.D1_FILIAL+SD1010.D1_LOCAL+'-'+Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
	SD1010.D1_TES AS 'TES', 
	SF4010.F4_TEXTO AS 'DESCRIÇÃO TES',
	SD1010.D1_CC AS 'CENTRO DE CUSTO',
	CASE WHEN SF4010.F4_ESTOQUE = 'S' THEN 'SIM' ELSE 'NÃO' END AS 'ATUALIZOU ESTOQUE?',	
	SF4010.F4_ESTOQUE AS 'PN-ATU. ESTOQUE',
	SF4010.F4_ATUATF AS 'PN-ATU. ATIVO',
	SF4010.F4_CF AS 'CFOP',
	SX5010.X5_DESCRI AS 'DESCRIÇÃO CFOP',
	SD1010.D1_DOC AS 'DOCUMENTO',
	SD1010.D1_ITEM AS 'ITEM',
	SD1010.D1_COD AS 'CODIGO',
	SD1010.D1_DESCRI AS 'DESCRIÇÃO',
	SD1010.D1_UM AS 'UND',
	SD1010.D1_QUANT AS 'QTDE DOC',
	SD1010.D1_VUNIT	AS 'VAL UND',
	SD1010.D1_TOTAL AS 'VAL TOTAL',
	CASE WHEN SD1010.D1_TES = '   ' THEN 'NÃO CLASSIFICADA' ELSE 'CLASSIFICADA' END AS 'CLASSIFICAÇÃO',	
	SF1010.F1_NMCLASS AS 'USUÁRIO CLASSIFICOU',
	SD1010.D1_CONTA AS 'CONTA CONTÁBIL',
	CASE WHEN SD1010.D1_CONTA = '                    ' THEN 'ATIVO FIXO' ELSE RTRIM(CT1010.CT1_DESC01) END AS 'DESC CONT CONTÁBIL',
	CASE WHEN SD1010.D1_CC = '         ' THEN 'PROCESSO PARA ARMAZÉM' ELSE RTRIM(CTT010.CTT_DESC01) END AS 'DESCRIÇÃO CENTRO DE CUSTO', 
	SD1010.D1_PEDIDO AS 'NUM PEDIDO',
	SD1010.D1_ITEMPC AS 'ITEM PEDIDO',
	
	--*************************************************--
	--*** DADOS DE SOLICITAÇÃO E PEDIDOS DE COMPRAS ***--
	--*************************************************--
	
	--DADOS DE PC
	SC7010.C7_NUMSC AS 'NUM SC',
	SC7010.C7_ITEMSC AS 'ITEM SC', 
	SC7010.C7_USER AS 'COD COMPRADOR',
	RTRIM(SY1010.Y1_NOME) AS 'NOME COMPRADOR',
	--FAZ PESQUISA NO HISTÓRICO DE COMPRAS SOBRE O PC EM QUESTÃO E RETORNA A DATA
		(
			SELECT
				TOP 1 Case RTrim(Coalesce(ZE2010.ZE2_DATA,'')) WHEN ''  THEN Null ELSE convert(DATETIME, ZE2010.ZE2_DATA, 112) END
			FROM ZE2010
			WHERE ZE2010.ZE2_PEDIDO = SC7010.C7_NUM AND ZE2010.ZE2_FILIAL = SC7010.C7_FILIAL AND ZE2010.D_E_L_E_T_ <> '*'
			ORDER BY ZE2010.R_E_C_N_O_ DESC
		) AS 'STATUS PC DATA ',
		
		(
			SELECT TOP 1 RTRIM(ZE2010.ZE2_OBS)
			FROM ZE2010
			WHERE ZE2010.ZE2_PEDIDO = SC7010.C7_NUM AND ZE2010.ZE2_FILIAL = SC7010.C7_FILIAL AND ZE2010.D_E_L_E_T_ <> '*'
			ORDER BY ZE2010.R_E_C_N_O_ DESC
		) AS 'OBS STATUS',
	--DATA DE APROVAÇÃO
		CONVERT(DATETIME,
			(
				SELECT MAX(LastUpdateDate)
				FROM (VALUES (SC7010.C7_DTLIB1),(SC7010.C7_DTLIB2),(SC7010.C7_DTLIB3),(SC7010.C7_DTLIB4),(SC7010.C7_DTLIB5),(SC7010.C7_DTLIB6),(SC7010.C7_DTLIB7), (SC7010.C7_EMISSAO), (SC7010.C7_ALTDATA)) AS UpdateDate(LastUpdateDate) 
			)
		, 112) AS 'DT APROVAÇÃO PC',
		--TEMPO ATÉ APROVAR PROCESSO
		DATEDIFF(DAY,
			CONVERT(DATETIME, IIF(SC7010.C7_ALTDATA>SC7010.C7_EMISSAO, SC7010.C7_ALTDATA, SC7010.C7_EMISSAO), 112),
			CONVERT(
			   DATETIME,
				   (
						SELECT MAX(LastUpdateDate)
						FROM (VALUES (SC7010.C7_DTLIB1),(SC7010.C7_DTLIB2),(SC7010.C7_DTLIB3),(SC7010.C7_DTLIB4),(SC7010.C7_DTLIB5),(SC7010.C7_DTLIB6),(SC7010.C7_DTLIB7), (SC7010.C7_EMISSAO), (SC7010.C7_ALTDATA)) AS UpdateDate(LastUpdateDate) 
					)
			)
		) AS 'TEMPO APROVA PC',
	
	--DADOS DE SC
	SC1010.C1_SOLICIT AS 'NOME SOLICITANTE SC',  
	SC1010.C1_OBS AS 'OBSERVAÇÃO',
	SC1010.C1_SOLICIT AS 'NOME SOLICITANTE SC',
	CASE WHEN SC1010.C1_TPCOMPR='2' THEN 'APLICAÇÃO DIRETA' WHEN SC1010.C1_TPCOMPR='1' THEN 'ESTOQUE' END AS 'TIPO DE COMPRA ',
	--DATA EM QUE O PROCESSO FOI APROVADO OU ULTIMA ATUALIZAÇÃO REGISTRADA
		CONVERT(DATETIME,
					(
						SELECT MAX(LastUpdateDate)
						FROM (VALUES (SC1010.C1_DTLIB1),(SC1010.C1_DTLIB2),(SC1010.C1_DTLIB3),(SC1010.C1_DTLIB4),(SC1010.C1_DTLIB5),(SC1010.C1_DTLIB6),(SC1010.C1_DTLIB7), (SC1010.C1_EMISSAO), (SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate) 
					)
		, 112) AS 'DT APROVAÇÃO SC',
		--TEMPO ATÉ APROVAR PROCESSO
		DATEDIFF(DAY,
			CONVERT(DATETIME, IIF(SC1010.C1_ALTDATA>SC1010.C1_EMISSAO, SC1010.C1_ALTDATA, SC1010.C1_EMISSAO), 112),
			CONVERT(
			   DATETIME,
				   (
						SELECT MAX(LastUpdateDate)
						FROM (VALUES (SC1010.C1_DTLIB1),(SC1010.C1_DTLIB2),(SC1010.C1_DTLIB3),(SC1010.C1_DTLIB4),(SC1010.C1_DTLIB5),(SC1010.C1_DTLIB6),(SC1010.C1_DTLIB7), (SC1010.C1_EMISSAO), (SC1010.C1_ALTDATA)) AS UpdateDate(LastUpdateDate) 
					)
			)
		) AS 'TEMPO APROVA SC',
	
	--*************************************************--
	--*** DADOS DE SOLICITAÇÃO E PEDIDOS DE COMPRAS ***--
	--*************************************************--
	
	SD1010.D1_QTDPEDI AS 'QTDE PEDIDO',
	SD1010.D1_FORNECE AS 'FORNECEDOR',
	
	--DADOS DE FORNECEDOR
	CASE WHEN SD1010.D1_FORNECE = '      ' THEN '' ELSE RTRIM(SA2010.A2_NOME)  END AS 'NOME FORNECEDOR',
	SA2010.A2_TIPO AS 'PESSOA JUR\FIS',
	SA2010.A2_CGC AS 'CNPJ\CPF',
	RTRIM(SA2010.A2_NREDUZ) AS 'NOME FANTASIA',
	RTRIM(SA2010.A2_END) AS 'ENDEREÇO',
	RTRIM(SA2010.A2_BAIRRO) AS 'BAIRRO',
	RTRIM(SA2010.A2_EST) AS 'UF',
	RTRIM(SA2010.A2_MUN) AS 'MUNICIPIO',
	RTRIM(SA2010.A2_CEP) AS 'CEP',
	CONCAT(RTRIM(SA2010.A2_DDD), '-', RTRIM(SA2010.A2_TEL)) AS 'TELEFONE',
	RTRIM(SA2010.A2_FAX) AS 'FAX',
	RTRIM(SA2010.A2_INSCR) AS 'INSCR ESTADUAL',
	RTRIM(SA2010.A2_CONTATO) AS 'CONTATO',
	Case RTrim(Coalesce(SA2010.A2_PRICOM,'')) WHEN ''  THEN Null ELSE convert(datetime,SA2010.A2_PRICOM, 112)END AS 'DT PRI COMPRA',
	Case RTrim(Coalesce(SA2010.A2_ULTCOM,'')) WHEN ''  THEN Null ELSE convert(datetime,SA2010.A2_ULTCOM, 112)END AS 'DT ULT COMPRA',
	RTRIM(SA2010.A2_EMAIL) AS 'EMAIL',
	RTRIM(SA2010.A2_HPAGE) AS 'HOME PAGE',
	RTRIM(SA2010.A2_COMPLEM) AS 'COMPLEMENTO',
	
	--DADOS DE PRODUTOS
	SB1010.B1_GRUPO AS 'COD GRUPO',
	RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',
	
	--DATAS DO PROCESSO
	Case RTrim(Coalesce(SD1010.D1_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime,SD1010.D1_EMISSAO, 112)END AS 'DT EMISSÃO', --DT EMISSÃO DA NF
	Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112)END AS 'DT DIGITAÇÃO', --DT EM QUE OCORREU A CLASSIFICAÇÃO
	Case RTrim(Coalesce(SF1010.F1_DTINCL,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTINCL, 112)END AS 'DT INCLUSÃO',
	Case RTrim(Coalesce(SF1010.F1_DTLANC,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTLANC, 112)END AS 'DT CLASSIFICAÇÃO',  --DT DA CONTABILIZAÇÃO
	Case RTrim(Coalesce(SF1010.F1_RECBMTO,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_RECBMTO, 112)END AS 'DT RECEBIMENTO', --DT EM QUE O MATERIAL FOI RECEBIDO
	
	SD1010.D1_CLVL AS 'COD DE OBRA',
	RTRIM(SD1010.D1_CLVL+' - '+CTH010.CTH_DESC01) AS 'DESC OBRA/PROJETO',
	SD1010.D1_SERIE AS 'SERIE',
	SD1010.D1_LOJA  AS 'LOJA',
	
	--DADOS DO ARMAZÉM
	CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END AS 'SITUAÇÃO',
	CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END AS 'TIPO',
	CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END AS 'INVENTARIADO?',
	CASE WHEN Z01010.Z01_OBRA = 'N' THEN 'Não' WHEN Z01010.Z01_OBRA = 'S' THEN 'Sim' ELSE 'ERRO' END AS 'OBRIGA OBRA?',
	SD1010.D1_NFORI AS 'NF ORIGEM',

	--DADOS DE CABEÇALHO DE PRENOTA
	SF1010.F1_NMUSER AS 'USUÁRIO INCLUIU PRENOTA',
	SF1010.F1_LOGNF AS 'HISTORICO NF',
	SF1010.F1_OBS AS 'OBS. PRE-NOTA', 
	SF1010.F1_MOTRET AS 'MOT. RETORNO', 
	SF1010.F1_OBSCLA AS 'OBS. CLASSIF',
	SF1010.F1_ESPECIE AS 'ESPEC. DOC',

	CASE
		WHEN (SD1010.D1_CC<>'          ' AND SF4010.F4_ESTOQUE = 'S')
			THEN 'COMPRA: AP DIRETA/ESTOQUE: SIM'
		WHEN (SD1010.D1_CC='          ' AND SF4010.F4_ESTOQUE <> 'S')
			THEN 'COMPRA: ESTOQUE/ESTOQUE: NÃO'
		ELSE 'ERRO'
	END AS 'TIPO PROCESSO',
	
	--CLASSIFICADOR DE GASTO
	CASE
		WHEN SD1010.D1_COD IN ('00130004', '00130002', '00130001') THEN 'FROTA - COMBUSTÍVEL'
		WHEN (SB1010.B1_GRUPO IN ('4004', '4005','4006', '4010') OR SD1010.D1_COD IN ('00526075','02550337','40030031','02550338','00510017','02550339')) THEN 'FROTA - VEICULOS'
		WHEN (SB1010.B1_GRUPO = '0014' OR BM_TIPGRU='MV') THEN 'FROTA - MATERIAIS VEICULARES'
		WHEN BM_TIPGRU='SV' THEN 'FROTA - SERVIÇOS VEICULARES'
		WHEN SB1010.B1_GRUPO = '1026' THEN 'FROTA - TRANSPORTE DE VEICULOS'
		WHEN SB1010.B1_GRUPO IN ('0982', '0984') THEN 'VIAGENS - REEMBOLSAVEIS'
		WHEN SB1010.B1_GRUPO IN ('0983', '0980', '0985', '0986', '0981') THEN 'VIAGENS - NÃO REEMBOLSAVEIS'
		WHEN SB1010.B1_GRUPO IN ('0740', '0861', '0863', '0864', '0719','1020', '0860') THEN 'UTILIDADES'
		WHEN SD1010.D1_COD = '10210001' THEN 'FRETES - REEMBOLSAVEIS'
		WHEN SB1010.B1_GRUPO IN ('1028', '1027', '1026') THEN 'FRETES - NÃO REEMBOLSAVEIS'
		WHEN (BM_TIPGRU IN ('SS','SV', 'FR', 'SG') OR (BM_TIPGRU = 'DG' AND LEFT(SB1010.B1_DESC,7)='SERVICO')) THEN 'SERVIÇOS TOMADOS'
		WHEN 
			(
				(SD1010.D1_CONTA = '                    ') OR
				(LEFT(SD1010.D1_CONTA,3)='132')
			) THEN 'INVESTIMENTO - ATIVO FIXO'
		WHEN (SD1010.D1_CC = '         ' AND SD1010.D1_FILIAL+SD1010.D1_LOCAL IN ('0221', '0222', '1291', '1292')) THEN 'ESTOQUE - INSUMOS PARA FATURAMENTO'
		WHEN (SD1010.D1_CC = '         ' AND SD1010.D1_CLVL = '001') THEN 'ESTOQUE - MOBILIZAÇÕES'
		WHEN (SD1010.D1_CC = '         ' AND SD1010.D1_CLVL <> '001') THEN 'ESTOQUE - CONSUMO OPERACIONAL'
		WHEN SD1010.D1_CLVL = '001' THEN 'INVESTIMENTO - MOBILIZAÇÕES'
		WHEN SD1010.D1_CC <> '         ' AND CTT010.CTT_TPCC = 'O' THEN 'APLICAÇÃO DIRETA - CUSTEIO OPERACIONAL'
		WHEN SD1010.D1_CC <> '         ' AND CTT010.CTT_TPCC = 'C' THEN 'APLICAÇÃO DIRETA - DESPESAS CORPORATIVAS'
		ELSE 'ERRO: CLASSIFICAR'
	END AS 'TIPO DE GASTO',
	
	--CLASSIFICADOR DE DEPARTAMENTO
	CASE 
		WHEN SB1010.B1_GRUPO IN ('0780','4006','0716','0051','0050','1026','0229','0096','0211','0012','0013','0014','0052','0053','0054','0090','0091','0092','0093','0094','0095','0098','0099','1021','4004','4005','4010') 
			THEN 'FROTA' 
		WHEN SB1010.B1_GRUPO IN ('1027','0227','0226','0215','0254','0212','0050','0051','0130','0131','0132','0133','0250','0253','0255','0256','0257','4003','4008') 
			THEN 'SUPRIMENTOS' 
		WHEN SB1010.B1_GRUPO IN ('0982','0983','0984','0980','0985','0986','0981','0702','0781','1065','0758','0215','0253','0252','0251','0755','0223','0170','0171','0172','0173','0175','0176','0177','0216','0701','0709','0711','0712','0717','0718','0719','0740','0747','0748','0754','0756','0860','0861','0863','0864','0980','0982','0983','1020','4007','4009') 
			THEN 'ADMINISTRATIVO' 
		ELSE 'GERAL' 
	END AS 'DPTO RESPONSÁVEL',
	
	--CLASSIFICADOR DE ÁREA DE COMPRA
	CASE
		WHEN (SC7010.C7_USER IN ('000044','000053','001193','001372','000238'))
			THEN 'COMPRAS'
		WHEN (SC7010.C7_USER IN ('000069','001417','000148','000852','000896','000655','000224','000190','001036','000444','001481','000797'))
			THEN 'ADM'
		WHEN (SC7010.C7_USER IN ('000216','001353','001362','000892','000815','001212','000554','000485','000663','001136','001042','000262','000937','000364','000567','001281','001391','001337','000246','001433','000894','001540','001328','000316','000993','000370','000376','000807','000306','000301','001506','000208','000571','000917','001562','000720','001329','001468','000435','001368','000283','000401'))
			THEN 'LOCAL'
		WHEN (SC7010.C7_USER IN ('000646','001494','001039','000226','001520','001165','001480','001211','000932','000050','000215','001145','000902','001280','000593','001161'))
			THEN 'MATRIZ - OUTROS'
		ELSE 'ERRO: CLASSIFICAR'
	END AS 'DPTO COMPRA'
	
FROM PROTHEUS.dbo.SD1010 SD1010 WITH (NOLOCK)
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 WITH (NOLOCK) ON (Z01010.Z01_FILIAL=SD1010.D1_FILIAL AND Z01010.Z01_COD=SD1010.D1_LOCAL) AND Z01010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.CT1010 CT1010 WITH (NOLOCK) ON SD1010.D1_CONTA=CT1010.CT1_CONTA AND CT1010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.CTT010 CTT010 WITH (NOLOCK) ON SD1010.D1_CC=CTT010.CTT_CUSTO AND CTT010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.CTH010 CTH010 WITH (NOLOCK) ON SD1010.D1_CLVL=CTH010.CTH_CLVL AND CTH010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 WITH (NOLOCK) ON SD1010.D1_FORNECE=SA2010.A2_COD AND SD1010.D1_LOJA=SA2010.A2_LOJA AND SA2010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 WITH (NOLOCK) ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA AND SF1010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 WITH (NOLOCK) ON SF4010.F4_CODIGO=SD1010.D1_TES AND SF4010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SX5010 SX5010 WITH (NOLOCK) ON SX5010.X5_TABELA='13' AND SX5010.X5_CHAVE=SF4010.F4_CF AND SX5010.D_E_L_E_T_<>'*'
	--CONEXÃO SC E PC
	LEFT JOIN PROTHEUS.dbo.SC7010 SC7010 WITH (NOLOCK) ON (SD1010.D1_PEDIDO=SC7010.C7_NUM AND SD1010.D1_ITEMPC=SC7010.C7_ITEM) AND SC7010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SC1010 SC1010 WITH (NOLOCK) ON (SC7010.C7_NUMSC=SC1010.C1_NUM AND SC7010.C7_ITEMSC=SC1010.C1_ITEM) AND SC1010.D_E_L_E_T_<>'*'
	--CONEXÃO PRODUTOS
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 WITH (NOLOCK) ON SD1010.D1_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 WITH (NOLOCK) ON SB1010.B1_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_<>'*'
	--CONEXÃO DE NOME DE COMPRADOR
	LEFT JOIN PROTHEUS.dbo.SY1010 SY1010 ON SC7010.C7_USER=SY1010.Y1_USER AND SY1010.D_E_L_E_T_<>'*'
	
WHERE
	SD1010.D1_FILIAL = '09' AND
	--DESCONSIDERA DELETADOS
	(SD1010.D_E_L_E_T_<>'*') AND
	(SF1010.F1_DTDIGIT>='20190101' AND SF1010.F1_DTDIGIT<=GETDATE()) AND
	--DESCONSIDERA IMPORTAÇÃO DE PRENOTAS
	(
		(SF4010.F4_TEXTO NOT LIKE '%*%') AND -- retira importação 1
		(SF1010.F1_ESPECIE <> 'SPE  ' OR SF1010.F1_ESPECIE <> 'SPE') AND -- retira importação 2
		(SF1010.F1_ESPECIE NOT LIKE 'NFE') -- retira importação 3
	) AND
	--GRUPOS QUE NÃO PERTENCEM À ANÁLISE (GERALMENTE PARTENCENTES AO RH)
	(SB1010.B1_GRUPO NOT IN ('0710','0093','0095','0096','1211','3000','3001','3002','3003','3004','3005','3006','3007','3050','3058','3060','3061')) AND
	--retira complemento de preço de frete
	(SD1010.D1_QUANT<>'0') AND 
	-- RETIRA TRANSFERÊNCIA E ARMAZÉM CLIENTE
	(
		LEFT(SA2010.A2_CGC,8)<>'05061494' AND -- ENDICON
		SA2010.A2_CGC<>'07047251000170' -- COELCE
	) AND
	--retira TES de transf e cliente
	(SD1010.D1_TES NOT IN ('417','451')) AND 
	--RETIRA FORNECEDORES INDESEJADOS
	(SD1010.D1_FORNECE NOT IN ('947678','948913')) AND 
	--RETIRAR ARMAZÉNS REUTILIZÁVEIS
	(SD1010.D1_FILIAL+SD1010.D1_LOCAL NOT IN ('0235','0242','0243')) 
	
	
	
	
	-- (
		-- (SD1010.D1_CC<>'          ' AND SF4010.F4_ESTOQUE = 'S') OR
		-- (SD1010.D1_CC='          ' AND SF4010.F4_ESTOQUE <> 'S')
	-- ) AND
	-- (SD1010.D_E_L_E_T_<>'*') AND
	-- (SF1010.F1_DTDIGIT>=DATEADD(DAY,-730,GETDATE()) AND SF1010.F1_DTDIGIT<=GETDATE()) AND
	-- (SD1010.D1_QUANT<>'0') AND --retira complemento de preço de frete
	-- (SC7010.C7_NUM <> '      ') AND -- RETIRA ALGUMAS PRENOTAS SEM MENÇÃO AO PC
	-- (SD1010.D1_TES<>'   ') AND --SOMENTE CLASSIFICADAS