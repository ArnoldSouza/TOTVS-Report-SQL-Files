DECLARE 
	@FILIAL VARCHAR(2) = '02',
	@ARMAZENS VARCHAR(2) = '11',
	@DT_INICIO VARCHAR(8) = '20170101',
	@DT_FIM VARCHAR(8) = '20171231';
	
/* -- ENTRADA POR PRÉ-NOTA */
	SELECT
		SD1010.D1_FILIAL AS 'FILIAL',
		SD1010.D1_LOCAL AS 'LOCAL',
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END AS 'TIPO',
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END AS 'SITUAÇÃO',
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END AS 'INVENTARIADO?',
		SD1010.D1_FILIAL+SD1010.D1_LOCAL+'-'+RTRIM(Z01010.Z01_DESC) AS 'DESCRIÇÃO ARMAZÉM',
		CAST(SF1010.F1_DTDIGIT AS DATETIME) AS 'DT EMISSÃO', 
		SD1010.D1_DOC AS 'DOCUMENTO',
		'NOTA FISCAL FORNECEDOR' AS 'TIPO DOCUMENTO',
		SD1010.D1_TES AS 'TM/TES',
		SB1010.B1_GRUPO AS 'COD GRUPO',
		RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',
		SD1010.D1_COD AS 'CODIGO',
		RTRIM(SD1010.D1_DESCRI) AS 'DESCRIÇÃO',
		SUM(SD1010.D1_QUANT) AS 'QUANTIDADE',
		SUM(SD1010.D1_TOTAL) AS 'VAL TOTAL',
		CASE WHEN RTRIM(SD1010.D1_CLVL)='001' THEN 'ENTRADA - PRÉ-NOTA: INVESTIMENTO/MOBILIZAÇÃO' ELSE 'ENTRADA - PRÉ-NOTA: CUSTEIO' END AS 'TIPO DE MOVIMENTO',
		CASE WHEN SF4010.F4_ESTOQUE = 'S' THEN 'SIM' ELSE 'NÃO' END AS 'ATUALIZOU ESTOQUE?'
	FROM PROTHEUS.dbo.SD1010 SD1010
		LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SD1010.D1_FILIAL+SD1010.D1_LOCAL)
		LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD1010.D1_COD=SB1010.B1_COD
		LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO
		LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA
		LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD1010.D1_TES
		LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON SA2010.A2_COD=SF1010.F1_FORNECE
	WHERE 	
		(SD1010.D_E_L_E_T_<>'*') AND
		(SD1010.D1_FILIAL=@FILIAL AND (SD1010.D1_LOCAL IN (@ARMAZENS))) AND
		(LEFT(SA2010.A2_CGC,8)<>'05061494') AND
		(
			(SF1010.F1_DTDIGIT>=@DT_INICIO AND SF1010.F1_DTDIGIT<=@DT_FIM) AND 
			(
				((SF4010.F4_ESTOQUE='S') OR (SF4010.F4_CODIGO='103' OR SF4010.F4_CODIGO='140')) OR
				(SD1010.D1_CC='          ' AND SD1010.D1_TES='   ')
			)
		)
	GROUP BY 
		SD1010.D1_FILIAL, 
		SD1010.D1_LOCAL, 
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END,
		SD1010.D1_FILIAL+SD1010.D1_LOCAL+'-'+RTRIM(Z01010.Z01_DESC),
		CAST(SF1010.F1_DTDIGIT AS DATETIME), 
		SD1010.D1_DOC,
		SD1010.D1_TES,
		SB1010.B1_GRUPO,
		SBM010.BM_DESC,
		SD1010.D1_COD,
		SD1010.D1_DESCRI,
		SD1010.D1_CLVL,
		SF4010.F4_ESTOQUE
		
Union ALL
	
	/* -- MOVIMENTOS POR TRANSFERÊNCIA INTERNA */
	SELECT
		SD3010.D3_FILIAL AS 'FILIAL', 
		SD3010.D3_LOCAL AS 'LOCAL', 
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END AS 'TIPO',
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END AS 'SITUAÇÃO',
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END AS 'INVENTARIADO?',
		SD3010.D3_FILIAL+SD3010.D3_LOCAL+'-'+RTRIM(Z01010.Z01_DESC) AS 'DESCRIÇÃO ARMAZÉM',	
		CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'DT EMISSÃO', 
		SD3010.D3_DOC AS 'DOCUMENTO',
		'RM-TRANSF. INTERN.' AS 'TIPO DOCUMENTO',
		SD3010.D3_TM AS 'TM/TES',
		SB1010.B1_GRUPO AS 'COD GRUPO',
		RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',
		SD3010.D3_COD AS 'COD', 
		RTRIM(SB1010.B1_DESC) AS 'DESCRIÇÃO', 
		CASE WHEN SD3010.D3_TM = '499' THEN SUM(SD3010.D3_QUANT) WHEN SD3010.D3_TM = '999' THEN SUM(SD3010.D3_QUANT*-1) END AS 'QUANTIDADE', 
		CASE WHEN SD3010.D3_TM = '499' THEN SUM(SB1010.B1_UPRC*SD3010.D3_QUANT)  WHEN SD3010.D3_TM = '999' THEN SUM((SB1010.B1_UPRC*SD3010.D3_QUANT)*-1) END AS 'VAL TOTAL', --ULT. PREÇ. COMPRA 
		CASE WHEN SD3010.D3_TM = '499' THEN 'ENTRADA - TRANSF. INTERNA' WHEN SD3010.D3_TM = '999' THEN 'SAÍDA - TRANSF. INTERNA' END AS 'TIPO DE MOVIMENTO',
		'SIM' AS 'ATUALIZOU ESTOQUE?'
	FROM PROTHEUS.dbo.SD3010 SD3010 
		LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*' 
		LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
		LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SD3010.D3_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_ <> '*' 
	WHERE
		(SD3010.D_E_L_E_T_<>'*') AND 
		(SD3010.D3_ESTORNO='') AND 
		--(SD3010.D3_DOC NOT LIKE '%INVENT%') AND 
		(SD3010.D3_TM='499' OR SD3010.D3_TM='999') AND 
		((SD3010.D3_EMISSAO>=@DT_INICIO) AND (SD3010.D3_EMISSAO<=@DT_FIM)) AND
		SD3010.D3_FILIAL = @FILIAL AND
		SD3010.D3_LOCAL IN (@ARMAZENS)
	GROUP BY 
		SD3010.D3_FILIAL,
		SD3010.D3_LOCAL,
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END,
		SD3010.D3_FILIAL+SD3010.D3_LOCAL+'-'+RTRIM(Z01010.Z01_DESC),
		CAST(SD3010.D3_EMISSAO AS DATETIME),
		SD3010.D3_DOC,
		SD3010.D3_TM,
		SB1010.B1_GRUPO,
		SBM010.BM_DESC,
		SD3010.D3_COD,
		SB1010.B1_DESC,
		SD3010.D3_TM
		
Union ALL

--ENTRADA TRANSF EXTERNA - ENTRADA
	SELECT
		SD1010.D1_FILIAL AS 'FILIAL',
		SD1010.D1_LOCAL AS 'LOCAL',
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END AS 'TIPO',
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END AS 'SITUAÇÃO',
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END AS 'INVENTARIADO?',
		SD1010.D1_FILIAL+SD1010.D1_LOCAL+'-'+RTRIM(Z01010.Z01_DESC) AS 'DESCRIÇÃO ARMAZÉM',
		CAST(SF1010.F1_DTDIGIT AS DATETIME) AS 'DT EMISSÃO',
		SD1010.D1_DOC AS 'DOCUMENTO',
		'NF REMESSA ENDICON' AS 'TIPO DOCUMENTO',
		SD1010.D1_TES AS 'TM/TES',
		SB1010.B1_GRUPO AS 'COD GRUPO',
		RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',
		SD1010.D1_COD AS 'CODIGO',
		RTRIM(SD1010.D1_DESCRI) AS 'DESCRIÇÃO',
		SUM(SD1010.D1_QUANT) AS 'QUANTIDADE',
		SUM(SD1010.D1_TOTAL) AS 'VAL TOTAL',
		'ENTRADA - TRANSF. EXTERNA' AS 'TIPO DE MOVIMENTO',
		CASE WHEN SF4010.F4_ESTOQUE = 'S' THEN 'SIM' ELSE 'NÃO' END AS 'ATUALIZOU ESTOQUE?'
	FROM PROTHEUS.dbo.SD1010 SD1010
		LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SD1010.D1_FILIAL+SD1010.D1_LOCAL)
		LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD1010.D1_COD=SB1010.B1_COD
		LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO
		LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA
		LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD1010.D1_TES
		LEFT JOIN PROTHEUS.dbo.SA2010 SA2010 ON  SA2010.A2_COD=SD1010.D1_FORNECE
	WHERE
		(SD1010.D_E_L_E_T_<>'*') AND
		(SD1010.D1_FILIAL=@FILIAL AND (SD1010.D1_LOCAL IN (@ARMAZENS))) AND
		(LEFT(SA2010.A2_CGC,8)='05061494') AND
		(
			(SF1010.F1_DTDIGIT>=@DT_INICIO AND SF1010.F1_DTDIGIT<=@DT_FIM) AND 
			(
				((SF4010.F4_ESTOQUE='S') OR (SF4010.F4_CODIGO='103' OR SF4010.F4_CODIGO='140')) OR
				(SD1010.D1_CC='          ' AND SD1010.D1_TES='   ')
			)
		) 
	GROUP BY 
		SD1010.D1_FILIAL, 
		SD1010.D1_LOCAL, 
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END,
		SD1010.D1_FILIAL+SD1010.D1_LOCAL+'-'+RTRIM(Z01010.Z01_DESC),
		SUBSTRING(SF1010.F1_DTDIGIT,5,2)+' - '+LEFT(SF1010.F1_DTDIGIT,4),
		SF1010.F1_DTDIGIT,
		SD1010.D1_DOC,
		SD1010.D1_TES,
		SB1010.B1_GRUPO,
		SBM010.BM_DESC,
		SD1010.D1_COD,
		SD1010.D1_DESCRI,
		SD1010.D1_CLVL,
		SF4010.F4_ESTOQUE

UNION ALL
		
	/* -- MOVIMENTOS POR TRANSFERÊNCIA EXTERNA - SAÍDA*/
	SELECT
		SD2010.D2_FILIAL AS 'FILIAL',
		SD2010.D2_LOCAL AS 'LOCAL',
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END AS 'TIPO',
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END AS 'SITUAÇÃO',
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END AS 'INVENTARIADO?',
		SD2010.D2_FILIAL+SD2010.D2_LOCAL+'-'+RTRIM(Z01010.Z01_DESC) AS 'DESCRIÇÃO ARMAZÉM',
		CAST(SD2010.D2_EMISSAO AS DATETIME) AS 'DT EMISSÃO', 
		SD2010.D2_PEDIDO AS 'DOCUMENTO',
		'PEDIDO DE VENDA' AS 'TIPO DOCUMENTO',
		SD2010.D2_TES AS 'TM/TES',
		SB1010.B1_GRUPO AS 'COD GRUPO',
		RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',
		SD2010.D2_COD AS 'CODIGO',
		RTRIM(SB1010.B1_DESC) AS 'DESCRIÇÃO',
		CASE WHEN SD2010.D2_TIPO = 'D' THEN SUM(SD2010.D2_QUANT) ELSE SUM(SD2010.D2_QUANT*-1) END AS 'QUANTIDADE', 
		CASE WHEN SD2010.D2_TIPO = 'D' THEN SUM(SD2010.D2_TOTAL) ELSE SUM(SD2010.D2_TOTAL*-1) END AS 'VAL TOTAL',
		CASE WHEN SD2010.D2_TIPO = 'D' THEN 'ENTRADA - DEVOLUÇÃO DE TRANSF. EXTERNA' ELSE 'SAÍDA - TRANSF. EXTERNA' END AS 'TIPO DE MOVIMENTO',
		CASE WHEN SF4010.F4_ESTOQUE = 'S' THEN 'SIM' ELSE 'NÃO' END AS 'ATUALIZOU ESTOQUE?'
	FROM PROTHEUS.dbo.SD2010 SD2010 
		LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER=(SD2010.D2_FILIAL+SD2010.D2_LOCAL) AND Z01010.D_E_L_E_T_ <> '*' 
		LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD2010.D2_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*' 
		LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_ <> '*' 
		LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD2010.D2_TES AND SF4010.D_E_L_E_T_ <> '*' 
	WHERE
		SD2010.D_E_L_E_T_<>'*' AND 
		((SD2010.D2_EMISSAO>=@DT_INICIO) AND (SD2010.D2_EMISSAO<=@DT_FIM)) AND
		SF4010.F4_ESTOQUE='S' AND
		SD2010.D2_FILIAL = @FILIAL AND
		SD2010.D2_LOCAL IN (@ARMAZENS)
	GROUP BY 
		SD2010.D2_FILIAL,
		SD2010.D2_LOCAL,
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END,
		SD2010.D2_FILIAL+SD2010.D2_LOCAL+'-'+RTRIM(Z01010.Z01_DESC),
		CAST(SD2010.D2_EMISSAO AS DATETIME),
		SD2010.D2_PEDIDO,
		SD2010.D2_TES,
		SB1010.B1_GRUPO,
		SBM010.BM_DESC,
		SD2010.D2_COD,
		SB1010.B1_DESC,
		SD2010.D2_TIPO,
		SF4010.F4_ESTOQUE
		
Union ALL
	
	/* -- MOVIMENTOS SOLICITAÇÃO AO ARMAZÉM - SAÍDA */
	SELECT
		SD3010.D3_FILIAL AS 'FILIAL',
		SD3010.D3_LOCAL AS 'LOCAL', 
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END AS 'TIPO',
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END AS 'SITUAÇÃO',
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END AS 'INVENTARIADO?',
		SD3010.D3_FILIAL+SD3010.D3_LOCAL+'-'+RTRIM(Z01010.Z01_DESC) AS 'DESCRIÇÃO ARMAZÉM',
		CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'DT EMISSÃO', 
		SD3010.D3_DOC AS 'DOCUMENTO',
		'RM-BAIXA DE SA' AS 'TIPO DOCUMENTO',
		SD3010.D3_TM AS 'TM/TES',
		SB1010.B1_GRUPO AS 'COD GRUPO',
		RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',
		SD3010.D3_COD AS 'COD', 
		RTRIM(SB1010.B1_DESC) AS 'DESCRIÇÃO', 
		SUM(SD3010.D3_QUANT*-1) AS 'QUANTIDADE',  
		SUM((SB1010.B1_UPRC*SD3010.D3_QUANT)*-1) AS 'VAL TOTAL', 
		CASE 
			WHEN SD3010.D3_TM = '501' AND RTRIM(SD3010.D3_CLVL)='001' THEN 'SAÍDA - INVESTIMENTO/MOBILIZAÇÃO SA ENDICON' 
			WHEN SD3010.D3_TM = '501' AND RTRIM(SD3010.D3_CLVL)<>'001' THEN 'SAÍDA - APLICAÇÃO SA ENDICON' 
			WHEN SD3010.D3_TM = '502' THEN 'SAÍDA - APLICAÇÃO SA CLIENTE' 
			WHEN SD3010.D3_TM = '505' THEN 'SAÍDA - APLICAÇÃO SA ATIVO' 
			WHEN SD3010.D3_TM = '506' THEN 'SAÍDA - ERRO SA S/ESTOQUE' 
			ELSE 'ERRO - TM NOVA - SAÍDA' 
		END AS 'TIPO DE MOVIMENTO',
		'SIM' AS 'ATUALIZOU ESTOQUE?'
	FROM PROTHEUS.dbo.SD3010 SD3010 
		LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*' 
		LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
		LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SD3010.D3_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_ <> '*'  
	WHERE
		(SD3010.D_E_L_E_T_<>'*') AND
		(LEFT(SD3010.D3_CF,2) = 'RE') AND
		(SD3010.D3_ESTORNO='') AND
		--(SD3010.D3_DOC NOT LIKE '%INVENT%') AND
		(SD3010.D3_TM<>'999' AND SD3010.D3_TM<>'503' AND SD3010.D3_TM<>'504') AND
		((SD3010.D3_EMISSAO>=@DT_INICIO) AND (SD3010.D3_EMISSAO<=@DT_FIM)) AND
		SD3010.D3_FILIAL = @FILIAL AND
		SD3010.D3_LOCAL IN (@ARMAZENS)
	GROUP BY 
		SD3010.D3_FILIAL,
		SD3010.D3_LOCAL,
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END,
		SD3010.D3_FILIAL+SD3010.D3_LOCAL+'-'+RTRIM(Z01010.Z01_DESC),
		CAST(SD3010.D3_EMISSAO AS DATETIME),
		SD3010.D3_DOC,
		SD3010.D3_TM,
		SB1010.B1_GRUPO,
		SBM010.BM_DESC,
		SD3010.D3_COD,
		SB1010.B1_DESC,
		SD3010.D3_TM,
		SD3010.D3_CLVL
		
Union ALL
	
	/* -- MOVIMENTOS SOLICITAÇÃO AO ARMAZÉM - ENTRADA */
	SELECT
		SD3010.D3_FILIAL AS 'FILIAL',
		SD3010.D3_LOCAL AS 'LOCAL', 
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END AS 'TIPO',
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END AS 'SITUAÇÃO',
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END AS 'INVENTARIADO?',
		SD3010.D3_FILIAL+SD3010.D3_LOCAL+'-'+RTRIM(Z01010.Z01_DESC) AS 'DESCRIÇÃO ARMAZÉM',
		CAST(SD3010.D3_EMISSAO AS DATETIME) AS 'DT EMISSÃO', 
		SD3010.D3_DOC AS 'DOCUMENTO',
		'RM-BAIXA DE SA' AS 'TIPO DOCUMENTO',
		SD3010.D3_TM AS 'TM/TES',
		SB1010.B1_GRUPO AS 'COD GRUPO',
		RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',
		SD3010.D3_COD AS 'COD', 
		RTRIM(SB1010.B1_DESC) AS 'DESCRIÇÃO', 
		SUM(SD3010.D3_QUANT) AS 'QUANTIDADE', 
		SUM((SB1010.B1_UPRC*SD3010.D3_QUANT)) AS 'VAL TOTAL', 
		CASE 
			WHEN SD3010.D3_TM = '001' AND RTRIM(SD3010.D3_CLVL)='001' THEN 'ENTRADA - DEVOLUÇÃO INVESTIMENTO/MOBILIZAÇÃO SA ENDICON' 
			WHEN SD3010.D3_TM = '001' AND RTRIM(SD3010.D3_CLVL)<>'001' THEN 'ENTRADA - DEVOLUÇÃO APLICAÇÃO SA ENDICON' 
			WHEN SD3010.D3_TM = '002' THEN 'ENTRADA - DEVOLUÇÃO SA CLIENTE' 
			WHEN SD3010.D3_TM = '005' THEN 'ENTRADA - DEVOLUÇÃO SA ATIVO' 
			ELSE 'ERRO - TM NOVA - ENTRADA' 
		END AS 'TIPO DE MOVIMENTO',
		'SIM' AS 'ATUALIZOU ESTOQUE?'
	FROM PROTHEUS.dbo.SD3010 SD3010 
		LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SD3010.D3_LOCAL=Z01010.Z01_COD AND SD3010.D3_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*' 
		LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SD3010.D3_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*'
		LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SD3010.D3_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_ <> '*'  
	WHERE
		(SD3010.D_E_L_E_T_<>'*') AND
		(LEFT(SD3010.D3_CF,2) = 'DE') AND
		(SD3010.D3_ESTORNO='') AND
		--(SD3010.D3_DOC NOT LIKE '%INVENT%') AND
		(SD3010.D3_TM<>'499' AND SD3010.D3_TM<>'003' AND SD3010.D3_TM<>'004') AND
		((SD3010.D3_EMISSAO>=@DT_INICIO) AND (SD3010.D3_EMISSAO<=@DT_FIM)) AND
		SD3010.D3_FILIAL = @FILIAL AND
		SD3010.D3_LOCAL IN (@ARMAZENS)
	GROUP BY 
		SD3010.D3_FILIAL,
		SD3010.D3_LOCAL,
		CASE WHEN Z01010.Z01_TME = '001' THEN 'Endicon' WHEN Z01010.Z01_TME = '002' THEN 'Cliente' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'Bloqueado' WHEN Z01010.Z01_MSBLQL = 2 THEN 'Desbloqueado' ELSE 'ERRO' END,
		CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END,
		SD3010.D3_FILIAL+SD3010.D3_LOCAL+'-'+RTRIM(Z01010.Z01_DESC),
		CAST(SD3010.D3_EMISSAO AS DATETIME),
		SD3010.D3_DOC,
		SD3010.D3_TM,
		SB1010.B1_GRUPO,
		SBM010.BM_DESC,
		SD3010.D3_COD,
		SB1010.B1_DESC,
		SD3010.D3_TM,
		SD3010.D3_CLVL

	