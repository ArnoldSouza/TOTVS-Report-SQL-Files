SELECT
	--SOLICITAÇÃO DE COMPRA
	SC1010.C1_FILIAL AS 'FILIAL', 
	SC1010.C1_LOCAL AS 'ARMAZÉM',
	SC1010.C1_FILIAL+SC1010.C1_LOCAL+' - '+Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
	SC1010.C1_NUM AS 'NUM SC', 
	SC1010.C1_ITEM AS 'ITEM', 
	SC1010.C1_PRODUTO AS 'CODIGO', 
	RTRIM(SC1010.C1_DESCRI) AS 'DESCRIÇÃO',
	
	SC1010.C1_QUANT AS 'QTDE SC', 
	SC1010.C1_QTDORIG AS 'QTDE ORIGI',
	SC1010.C1_VLESTIM AS 'VAL UND SC',
	SC1010.C1_VTOTAL AS 'TOTAL SC', 
	
	SC1010.C1_QUJE AS 'QTDE EM PEDIDO',
	SC1010.C1_QUJE*SC1010.C1_VLESTIM AS 'VALOR ATENDIDO',
	(SC1010.C1_QTDORIG-SC1010.C1_QUJE) AS 'QTDE FALTA',
	(SC1010.C1_QTDORIG-SC1010.C1_QUJE)*SC1010.C1_VLESTIM AS 'VAL FALTA',
	SC1010.C1_OBS AS 'OBSERVAÇÃO', 
	SC1010.C1_RESIDUO AS 'ELIMINADO RESIDUO',
	SC1010.C1_CODCOMP AS 'CODCOMP',
	SB1010.B1_GRUPO AS 'COD GRUPO',
	RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO',
	CASE WHEN SC1010.C1_APROV = 'B' THEN 'BLOQUEADA' WHEN SC1010.C1_APROV = 'L' THEN 'LIBERADA' ELSE 'REJEITADA'  END AS 'SITUAÇÃO SC', 
	CASE 
		WHEN SC1010.C1_QUJE=SC1010.C1_QUANT THEN 'COMPRADO TOTALMENTE'
		WHEN SC1010.C1_QUJE=0 THEN 'FALTA COMPRAR'
		WHEN SC1010.C1_QUJE<SC1010.C1_QUANT AND SC1010.C1_QUJE>0 THEN 'COMPRADO PARCIAL'
		ELSE 'ERRO'
	END AS 'SITUAÇÃO DA SC',
	
	Case RTrim(Coalesce(SC1010.C1_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_EMISSAO, 112)END AS 'DT EMISSÃO SC',
	Case RTrim(Coalesce(SC1010.C1_ALTDATA,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_ALTDATA, 112)END AS 'DT ALT SC',

	Case RTrim(Coalesce(SC1010.C1_DTLIB1,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_DTLIB1, 112)END AS 'DT SC LIBERADO1',
	Case RTrim(Coalesce(SC1010.C1_DTLIB2,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_DTLIB2, 112)END AS 'DT SC LIBERADO2',
	Case RTrim(Coalesce(SC1010.C1_DTLIB3,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_DTLIB3, 112)END AS 'DT SC LIBERADO3',
	Case RTrim(Coalesce(SC1010.C1_DTLIB4,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_DTLIB4, 112)END AS 'DT SC LIBERADO4',
	Case RTrim(Coalesce(SC1010.C1_DTLIB5,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_DTLIB5, 112)END AS 'DT SC LIBERADO5',
	Case RTrim(Coalesce(SC1010.C1_DTLIB6,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_DTLIB6, 112)END AS 'DT SC LIBERADO6',
	Case RTrim(Coalesce(SC1010.C1_DTLIB7,'')) WHEN ''  THEN Null ELSE convert(datetime, SC1010.C1_DTLIB7, 112)END AS 'DT SC LIBERADO7',
	
	--PEDIDO DE COMPRA
	SC7010.C7_NUM AS 'NUM PC',
	SC7010.C7_ITEM AS 'ITEM',
	SC7010.C7_USER AS 'COD COMPRADOR',
	RTRIM(SY1010.Y1_NOME) AS 'NOME COMPRADOR',
	SC7010.C7_QUANT AS 'QTDE PC',
	SC7010.C7_QUJE AS 'QTDE ENTREGUE',
	SC7010.C7_QTDACLA AS 'QTDE A CLASSI',
	SC7010.C7_PRECO AS 'VAL UND PC',
	SC7010.C7_TOTAL AS 'TOTAL PC',
	SC7010.C7_QUJE+SC7010.C7_QTDACLA AS 'QUANTIDADE RECEBIDA',
	(SC7010.C7_QUJE+SC7010.C7_QTDACLA)*SC7010.C7_PRECO AS 'TOTAL RECEBIDO',
	SC7010.C7_FORNECE AS 'FORNECEDOR',
	SC7010.C7_NOMFOR AS 'NOME FORNECEDOR',
	SC7010.C7_RESIDUO AS 'PC ELIM RESIDUO',
	CASE WHEN SC7010.C7_CONAPRO = 'L' THEN 'APROVADO' ELSE 'BLOQUEADO' END AS 'SITUAÇÃO PC',	
	CASE 
		WHEN SC7010.C7_QUJE=SC7010.C7_QUANT THEN 'RECEBIDO TOTALMENTE'
		WHEN SC7010.C7_QUJE=0 THEN 'FALTA RECEBER'
		WHEN SC7010.C7_QUJE<SC7010.C7_QUANT AND SC7010.C7_QUJE>0 THEN 'RECEBIDO PARCIAL'
		ELSE 'ERRO'
	END AS 'SITUAÇÃO DO PC',
	
	Case RTrim(Coalesce(SC7010.C7_EMISSAO,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_EMISSAO, 112)END AS 'DT EMISSÃO PC',
	Case RTrim(Coalesce(SC7010.C7_ALTDATA,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_ALTDATA, 112)END AS 'DT ALT PC',
	
	Case RTrim(Coalesce(SC1010.C1_DTLIB1,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_DTLIB1, 112)END AS 'DT PC LIBERADO1',
	Case RTrim(Coalesce(SC1010.C1_DTLIB2,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_DTLIB2, 112)END AS 'DT PC LIBERADO2',
	Case RTrim(Coalesce(SC1010.C1_DTLIB3,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_DTLIB3, 112)END AS 'DT PC LIBERADO3',
	Case RTrim(Coalesce(SC1010.C1_DTLIB4,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_DTLIB4, 112)END AS 'DT PC LIBERADO4',
	Case RTrim(Coalesce(SC1010.C1_DTLIB5,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_DTLIB5, 112)END AS 'DT PC LIBERADO5',
	Case RTrim(Coalesce(SC1010.C1_DTLIB6,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_DTLIB6, 112)END AS 'DT PC LIBERADO6',
	Case RTrim(Coalesce(SC1010.C1_DTLIB7,'')) WHEN ''  THEN Null ELSE convert(datetime, SC7010.C7_DTLIB7, 112)END AS 'DT PC LIBERADO7',
	
	--PRÉ NOTA
	(
		SELECT
			SUM(SD1010.D1_QUANT) AS QTDE_DOC
		FROM PROTHEUS.dbo.SD1010 SD1010
		WHERE
			SC7010.C7_NUM=SD1010.D1_PEDIDO AND 
			SC7010.C7_ITEM=SD1010.D1_ITEMPC AND 
			SD1010.D_E_L_E_T_<>'*'
	) AS 'QTDE DOC',
	
	(
		SELECT
			 SUM(SD1010.D1_TOTAL) / SUM(SD1010.D1_QUANT)  AS VAL_UND
		FROM PROTHEUS.dbo.SD1010 SD1010
		WHERE
			SC7010.C7_NUM=SD1010.D1_PEDIDO AND 
			SC7010.C7_ITEM=SD1010.D1_ITEMPC AND 
			SD1010.D_E_L_E_T_<>'*'
	) AS 'VAL UND',
	
	(
		SELECT
			SUM(SD1010.D1_TOTAL) AS VAL_TOTAL
		FROM PROTHEUS.dbo.SD1010 SD1010
		WHERE
			SC7010.C7_NUM=SD1010.D1_PEDIDO AND 
			SC7010.C7_ITEM=SD1010.D1_ITEMPC AND 
			SD1010.D_E_L_E_T_<>'*'
	) AS 'VAL TOTAL',
	
	(
		SELECT
			TOP 1 Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112)END AS DT_PRENOTA
		FROM PROTHEUS.dbo.SD1010 SD1010
			LEFT OUTER JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SF1010.D_E_L_E_T_<>'*'
		WHERE
			SC7010.C7_NUM=SD1010.D1_PEDIDO AND 
			SC7010.C7_ITEM=SD1010.D1_ITEMPC AND 
			SD1010.D_E_L_E_T_<>'*'
	) AS 'DT PRÉNOTA'
	
FROM PROTHEUS.dbo.SC1010 SC1010
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SC1010.C1_FILIAL + SC1010.C1_LOCAL)
	LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SC1010.C1_PRODUTO=SB1010.B1_COD
	LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO
	LEFT JOIN PROTHEUS.dbo.SC7010 SC7010 ON SC1010.C1_NUM=SC7010.C7_NUMSC AND SC1010.C1_ITEM=SC7010.C7_ITEMSC AND SC7010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SY1010 SY1010 ON SC7010.C7_USER=SY1010.Y1_USER
	
WHERE
	(SC1010.D_E_L_E_T_<>'*') AND
	((SC1010.C1_EMISSAO>='20160101')) AND
	--GRUPOS QUE NÃO PERTENCEM À ANÁLISE (GERALMENTE PARTENCENTES AO RH)
	(SB1010.B1_GRUPO NOT IN ('1060','0174','3001','3005','0702','0703','0707','0710','1024','1025','3002','3003','3007','3050','3060','0720','0752','1200','3004','1203','0700','0706','0743','0780','0781','0782','0820','0822','0823','0825','1022','1065','1202','1204','1205','1206','1208','1211','1213','1215','1219','3000','3006','3008','3054','4006','7000')) AND
	(SC1010.C1_APROV='L') AND
	-- (SC1010.C1_FILIAL='02' AND (SC1010.C1_LOCAL='25' OR SC1010.C1_LOCAL='28' OR SC1010.C1_LOCAL='32')) AND
	(SC1010.C1_CC = '          ') AND
	((SC1010.C1_CODCOMP='012' OR SC1010.C1_CODCOMP='010') OR (SC7010.C7_USER='000044' OR SC7010.C7_USER='000053'))
	
	

