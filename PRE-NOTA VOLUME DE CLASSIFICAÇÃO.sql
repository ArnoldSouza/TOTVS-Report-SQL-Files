SELECT
	RTRIM(SF1010.F1_FORNECE)+'-'+RTRIM(SF1010.F1_DOC)+'-'+RTRIM(SF1010.F1_SERIE) AS 'NUM SEQUENCIAL',
  Case RTrim(Coalesce(SF1010.F1_RECBMTO,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_RECBMTO, 112)END AS 'DT RECEBIMENTO',
  Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112)END AS 'DT CLASSIFICAÇÃO',
  DATEDIFF(day, SF1010.F1_RECBMTO, SF1010.F1_DTDIGIT) AS 'TEMPO',

  SF1010.F1_NMCLASS AS 'USUÁRIO CLASSIFICOU',
  SD1010.D1_FORNECE AS 'FORNECEDOR',

  CASE
    WHEN SD1010.D1_TES IN ('417','451') THEN 'ESTOQUE: CLIENTE/TRANSF'
    WHEN (SF4010.F4_ESTOQUE = 'N' AND SF4010.F4_ATUATF = 'S') THEN 'ATIVO'
    WHEN (SF4010.F4_ESTOQUE = 'S' AND SF4010.F4_ATUATF = 'N') THEN 'ESTOQUE: MAT ENDICON'
    ELSE 'AP DIRETA'
  END AS 'TIPO PROCESSO'

FROM PROTHEUS.dbo.SD1010 SD1010
	LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA
	LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD1010.D1_TES

WHERE
  (SD1010.D_E_L_E_T_<>'*') AND
  (SF1010.F1_DTDIGIT>='20170101' AND SF1010.F1_DTDIGIT<='20180228') AND
  SF1010.F1_RECBMTO<>'' AND
  DATEDIFF(day, SF1010.F1_RECBMTO, SF1010.F1_DTDIGIT)>=0 AND
  (
		(SF4010.F4_TEXTO NOT LIKE '%*%') AND -- retira importação 1
		(SF1010.F1_ESPECIE <> 'SPE  ' OR SF1010.F1_ESPECIE <> 'SPE') AND -- retira importação 2
		(SF1010.F1_ESPECIE NOT LIKE 'NFE') -- retira importação 3
	)

GROUP BY
  RTRIM(SF1010.F1_FORNECE)+'-'+RTRIM(SF1010.F1_DOC)+'-'+RTRIM(SF1010.F1_SERIE),
  Case RTrim(Coalesce(SF1010.F1_RECBMTO,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_RECBMTO, 112)END,
  Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112)END,
  DATEDIFF(day, SF1010.F1_RECBMTO, SF1010.F1_DTDIGIT),
  CASE
    WHEN SD1010.D1_TES IN ('417','451') THEN 'ESTOQUE: CLIENTE/TRANSF'
    WHEN (SF4010.F4_ESTOQUE = 'N' AND SF4010.F4_ATUATF = 'S') THEN 'ATIVO'
    WHEN (SF4010.F4_ESTOQUE = 'S' AND SF4010.F4_ATUATF = 'N') THEN 'ESTOQUE: MAT ENDICON'
    ELSE 'AP DIRETA'
  END,
  SF1010.F1_NMCLASS,SD1010.D1_FORNECE