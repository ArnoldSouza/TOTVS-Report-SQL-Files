SELECT
	SCP010.CP_FILIAL AS 'FILIAL',
	SCP010.CP_LOCAL AS 'ARMAZÉM',
	RTRIM(Z01010.Z01_DESC) AS 'DESC_ALMOX', 
	CAST(SCP010.CP_EMISSAO AS DATETIME) AS 'DT EMISSÃO',
	
	COUNT(DISTINCT SCP010.CP_NUM) AS 'QTD SA',
	
	SUM(PRODUTO.ULTIMO_PREÇO*SCP010.CP_QUANT) AS 'R$ TOTAL SA (ULT R$ COMPR)', 
	SUM(PRODUTO.ULTIMO_PREÇO*SCP010.CP_QUJE) AS 'R$ TOTAL ATENDIDO (ULT R$ COMPR)', 
	SUM((SCP010.CP_QUANT-SCP010.CP_QUJE)*PRODUTO.ULTIMO_PREÇO) AS 'R$ TOTAL FALTA ATENDER (ULT R$ COMPR)',
	
	CASE
		WHEN 
			(
				SCP010.CP_PREREQU=' ' AND
				SCP010.CP_QUJE='0' AND
				SCP010.CP_STATUS=' ' AND
				SCP010.CP_STATSA='B'
			) THEN 'BLOQUEADA'
		WHEN 
			(
				SCP010.CP_PREREQU=' ' AND
				SCP010.CP_QUJE='0' AND
				SCP010.CP_STATUS=' ' AND
				SCP010.CP_STATSA='L'
			) THEN 'APROVADA'
		WHEN 
			(
				SCP010.CP_PREREQU='S' AND
				SCP010.CP_QUJE='0' AND
				SCP010.CP_STATUS=' ' AND
				SCP010.CP_STATSA='L'
			) THEN 'PRÉ-REQUISIÇÃO - GERADA'
		WHEN 
			(
				SCP010.CP_PREREQU='S' AND
				SCP010.CP_QUJE>'0' AND
				SCP010.CP_STATUS='E' AND
				SCP010.CP_STATSA='L'
			) THEN 'BAIXADA'
		WHEN 
			(
				SCP010.CP_PREREQU='S' AND
				(SCP010.CP_QUJE>'0' AND SCP010.CP_QUJE<SCP010.CP_QUANT) AND
				SCP010.CP_STATUS=' ' AND
				SCP010.CP_STATSA='L'
			) THEN 'BAIXADA - PARCIALMENTE'
		WHEN 
			(
				SCP010.CP_PREREQU='S' AND
				SCP010.CP_QUJE='0' AND
				SCP010.CP_STATUS='E' AND
				(SCP010.CP_STATSA='L' OR SCP010.CP_STATSA='B')
			) THEN 'PRÉ-REQUISIÇÃO - ENCERRADA'
		ELSE
			'ELIMINADA RESÍDUO'
	END AS 'SITUAÇÃO'
FROM PROTHEUS.dbo.SCP010 SCP010 
	LEFT JOIN 
		(
			SELECT 
				SB1010.B1_COD AS CODIGO,
				SB1010.B1_UPRC AS ULTIMO_PREÇO
			FROM PROTHEUS.dbo.SB1010 SB1010
			WHERE
				(SB1010.D_E_L_E_T_<>'*')
		) AS PRODUTO ON SCP010.CP_PRODUTO=PRODUTO.CODIGO
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON SCP010.CP_LOCAL=Z01010.Z01_COD AND SCP010.CP_FILIAL=Z01010.Z01_FILIAL AND Z01010.D_E_L_E_T_ <> '*' 
WHERE
	SCP010.D_E_L_E_T_<>'*' AND
	(SCP010.CP_EMISSAO>='20170101' AND SCP010.CP_EMISSAO<='20171231') AND
	Z01010.Z01_MSBLQL = 2 AND
	Z01010.Z01_TME = '001'
GROUP BY
	SCP010.CP_FILIAL,
	SCP010.CP_LOCAL,
	RTRIM(Z01010.Z01_DESC),
	CAST(SCP010.CP_EMISSAO AS DATETIME),
	CASE
		WHEN 
			(
				SCP010.CP_PREREQU=' ' AND
				SCP010.CP_QUJE='0' AND
				SCP010.CP_STATUS=' ' AND
				SCP010.CP_STATSA='B'
			) THEN 'BLOQUEADA'
		WHEN 
			(
				SCP010.CP_PREREQU=' ' AND
				SCP010.CP_QUJE='0' AND
				SCP010.CP_STATUS=' ' AND
				SCP010.CP_STATSA='L'
			) THEN 'APROVADA'
		WHEN 
			(
				SCP010.CP_PREREQU='S' AND
				SCP010.CP_QUJE='0' AND
				SCP010.CP_STATUS=' ' AND
				SCP010.CP_STATSA='L'
			) THEN 'PRÉ-REQUISIÇÃO - GERADA'
		WHEN 
			(
				SCP010.CP_PREREQU='S' AND
				SCP010.CP_QUJE>'0' AND
				SCP010.CP_STATUS='E' AND
				SCP010.CP_STATSA='L'
			) THEN 'BAIXADA'
		WHEN 
			(
				SCP010.CP_PREREQU='S' AND
				(SCP010.CP_QUJE>'0' AND SCP010.CP_QUJE<SCP010.CP_QUANT) AND
				SCP010.CP_STATUS=' ' AND
				SCP010.CP_STATSA='L'
			) THEN 'BAIXADA - PARCIALMENTE'
		WHEN 
			(
				SCP010.CP_PREREQU='S' AND
				SCP010.CP_QUJE='0' AND
				SCP010.CP_STATUS='E' AND
				(SCP010.CP_STATSA='L' OR SCP010.CP_STATSA='B')
			) THEN 'PRÉ-REQUISIÇÃO - ENCERRADA'
		ELSE
			'ELIMINADA RESÍDUO'
	END
