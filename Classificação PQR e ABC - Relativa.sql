/* 
QUERY DE APOIO NA CLASSIFICAÇÃO ABC RELATIVA
NA ENDICON ENGENHARIA 
*/

WITH SALDOS AS
(
	SELECT 
		Z01010.Z01_CODGER AS 'LOCAL',
		SB2010.B2_FILIAL AS 'FILIAL', 
		SB2010.B2_LOCAL AS 'ARMAZÉM', 
		Z01010.Z01_DESC AS 'DESCRIÇÃO ARMAZÉM',
		CASE WHEN Z01010.Z01_MSBLQL = 1 THEN 'BLOQUEADO' WHEN Z01010.Z01_MSBLQL = 2 THEN 'DESBLOQUEADO' ELSE 'ERRO' END AS 'SITUAÇÃO',
		CASE WHEN Z01010.Z01_TIPO = 1 THEN 'ESTOQUE' WHEN Z01010.Z01_TIPO = 2 THEN 'APLIC DIRETA' ELSE 'ERRO' END AS 'TIPO APLICAÇÃO',
		CASE WHEN Z01010.Z01_TME = '001' THEN 'ENDICON' WHEN Z01010.Z01_TME = '002' THEN 'CLIENTE' WHEN Z01010.Z01_TME = '006' THEN 'USADOS' ELSE 'ERRO' END AS 'TIPO ARMAZÉM',
		--CASE WHEN Z01010.Z01_INVET = 1 THEN 'Sim' WHEN Z01010.Z01_INVET = 2 THEN 'Não' ELSE 'ERRO' END AS 'INVENTARIADO?',
		--CASE WHEN Z01010.Z01_OBRA = 'N' THEN 'Não' WHEN Z01010.Z01_OBRA = 'S' THEN 'Sim' ELSE 'ERRO' END AS 'OBRIGA OBRA?',
		RTRIM(SB2010.B2_COD) AS 'PRODUTO', 
		RTRIM(SB1010.B1_DESC) AS 'DESCRIÇÃO', 
		SB2010.B2_QATU AS 'QTD', 
		SB2010.B2_CM1 AS 'CUSTO TOTVS',
		SB2010.B2_VATU1 AS 'VALOR TOTVS',
		SB1010.B1_UPRC AS 'CUSTO UPC',
		SB1010.B1_UPRC*SB2010.B2_QATU AS 'VALOR UPC',

		-- (
			-- SELECT AVG(SC7010.C7_PRECO)
			-- FROM PROTHEUS.dbo.SC7010 SC7010
			-- WHERE (SC7010.D_E_L_E_T_<>'*') AND (SC7010.C7_EMISSAO>'20140312') AND (SC7010.C7_CONAPRO='L') AND (SC7010.C7_QUJE>0) AND (SC7010.C7_RESIDUO<>'S') AND (SB2010.B2_COD=SC7010.C7_PRODUTO)
		-- ) AS 'CUSTO MEDIO',

		--POPULARIDADE DE SAÍDA ATRAVÉS DE SA (SOLICITAÇÃO AO ARMAZÉM)
		(
			SELECT COUNT(SD3010.D3_COD)
			FROM PROTHEUS.dbo.SD3010 SD3010 
			WHERE
				(SD3010.D_E_L_E_T_<>'*') AND --RETIRA DELETADOS
				(LEFT(SD3010.D3_CF,2) = 'RE') AND --APENAS SAÍDA
				(SD3010.D3_ESTORNO='') AND --DESCONSIDERA ESTORNO
				(SD3010.D3_DOC NOT LIKE '%INVENT%') AND --DESCONSIDERA INVENTARIO
				(SD3010.D3_TM<>'503' AND SD3010.D3_TM<>'504') AND --DESCONSIDERA ALGUNS MOVIMENTOS
				(SD3010.D3_CLVL <> '001') AND -- DESCONSIDERA MOBILIZAÇÃO
				(
					SD3010.D3_EMISSAO>=DATEADD(DAY,-365,GETDATE()) AND SD3010.D3_EMISSAO<=GETDATE() --EQUIVALENTE A UM ANO 
				) AND
				SD3010.D3_COD=SB2010.B2_COD AND --FIXA POR CÓDIGO
				SD3010.D3_FILIAL = Z01010.Z01_FILIAL AND --FIXA FILIAL
				SD3010.D3_LOCAL = Z01010.Z01_COD --FIXA ARMAZÉM
		) AS 'POPULARIDADE SAI',

		(
			SELECT SUM(SD3010.D3_QUANT)
			FROM PROTHEUS.dbo.SD3010 SD3010 
			WHERE
				(SD3010.D_E_L_E_T_<>'*') AND --RETIRA DELETADOS
				(LEFT(SD3010.D3_CF,2) = 'RE') AND --APENAS SAÍDA
				(SD3010.D3_ESTORNO='') AND --DESCONSIDERA ESTORNO
				(SD3010.D3_DOC NOT LIKE '%INVENT%') AND --DESCONSIDERA INVENTARIO
				(SD3010.D3_TM<>'503' AND SD3010.D3_TM<>'504') AND --DESCONSIDERA ALGUNS MOVIMENTOS
				(SD3010.D3_CLVL <> '001') AND -- DESCONSIDERA MOBILIZAÇÃO
				(
					SD3010.D3_EMISSAO>=DATEADD(DAY,-365,GETDATE()) AND SD3010.D3_EMISSAO<=GETDATE() --EQUIVALENTE A UM ANO 
				) AND
				SD3010.D3_COD=SB2010.B2_COD AND --FIXA POR CÓDIGO
				SD3010.D3_FILIAL = Z01010.Z01_FILIAL AND --FIXA FILIAL
				SD3010.D3_LOCAL = Z01010.Z01_COD --FIXA ARMAZÉM
		) AS 'CONSUMO ANUAL',

		(
			SELECT SUM(SD1010.D1_QUANT)
			FROM PROTHEUS.dbo.SD1010 SD1010
			WHERE SD1010.D1_FILIAL=SB2010.B2_FILIAL 
				AND SD1010.D1_LOCAL=SB2010.B2_LOCAL
				AND SD1010.D1_COD=SB2010.B2_COD
				AND SD1010.D1_CC=''
				AND SD1010.D1_TES='   '
				AND SD1010.D_E_L_E_T_<>'*'
		) AS 'QTDE PRENOTA',

		(
			SELECT SUM(SD1010.D1_TOTAL)
			FROM PROTHEUS.dbo.SD1010 SD1010
			WHERE SD1010.D1_FILIAL=SB2010.B2_FILIAL
				AND  SD1010.D1_LOCAL=SB2010.B2_LOCAL
				AND SD1010.D1_COD=SB2010.B2_COD
				AND SD1010.D1_CC=''
				AND SD1010.D1_TES='   '
				AND SD1010.D_E_L_E_T_<>'*'
		) AS 'VALOR PRENOTA',

		CASE RTRIM(COALESCE(SB2010.B2_USAI,'')) WHEN ''  THEN NULL ELSE CONVERT(DATETIME,SB2010.B2_USAI, 112)END AS 'DT ULT SAÍDA',
		Case RTrim(Coalesce(SB2010.B2_DINVENT,'')) WHEN ''  THEN Null ELSE convert(datetime,SB2010.B2_DINVENT, 112)END AS 'DT INVENT',

		SB1010.B1_GRUPO AS 'COD GRUPO',
		RTRIM(SBM010.BM_DESC) AS 'DESC GRUPO'

	FROM PROTHEUS.dbo.SB2010 SB2010 -- LINK DE SALDO EM ESTOQUE
		LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SB2010.B2_FILIAL+SB2010.B2_LOCAL) AND Z01010.D_E_L_E_T_ <> '*'-- CONEXÃO DE ARMAZÉM 
		LEFT JOIN PROTHEUS.dbo.SB1010 SB1010 ON SB2010.B2_COD=SB1010.B1_COD AND SB1010.D_E_L_E_T_ <> '*' -- CONEXÃO DE PRODUTOS
		LEFT JOIN PROTHEUS.dbo.SBM010 SBM010 ON SB1010.B1_GRUPO=SBM010.BM_GRUPO AND SBM010.D_E_L_E_T_ <> '*'-- CONEXÃO DE GRUPOS DE PRODUTOS
	WHERE
		(Z01010.Z01_MSBLQL = 2) AND -- SOMENTE ARMAZEM DESBLOQUEADO
		(SB2010.D_E_L_E_T_<>'*') AND  -- DESCONSIDERA DELETADOS
		Z01010.Z01_CODGER IN ('0745','0747','0742', '0740', '0749')
)

SELECT
	*,
	SD.[VALOR UPC]/SUM(SD.[VALOR UPC]) OVER (PARTITION BY SD.[LOCAL]) AS '% TOTAL UPC',
	SUM(SD.[VALOR UPC]) OVER (PARTITION BY SD.[LOCAL] ORDER BY SD.[VALOR UPC] DESC)/SUM(SD.[VALOR UPC]) OVER (PARTITION BY SD.[LOCAL]) AS '% ACUM',
	CASE
		WHEN SD.[VALOR UPC] = 0 
            THEN 'D'
        WHEN (SUM(SD.[VALOR UPC]) OVER (PARTITION BY SD.[LOCAL] ORDER BY SD.[VALOR UPC] DESC)/SUM(SD.[VALOR UPC]) OVER (PARTITION BY SD.[LOCAL])) <= 0.8 
            THEN 'A'
        WHEN (SUM(SD.[VALOR UPC]) OVER (PARTITION BY SD.[LOCAL] ORDER BY SD.[VALOR UPC] DESC)/SUM(SD.[VALOR UPC]) OVER (PARTITION BY SD.[LOCAL])) <= 0.95 
            THEN 'B'
        ELSE 'C'
    END AS 'CLASSE ABC',
	CASE
		WHEN SD.[POPULARIDADE SAI] = 0 THEN 'SEM MOV' --SEM MOVIMENTO
		WHEN SD.[POPULARIDADE SAI] >= 276 THEN 'P-1D' -- PELO MENOS UMA VEZ/DIA
		WHEN SD.[POPULARIDADE SAI] >= 48 THEN 'Q-7D' -- PELO MENOS UMA VEZ/SEMANA
		WHEN SD.[POPULARIDADE SAI] >= 12 THEN 'R-30D' -- PELO MENOS UMA VEZ/MÊS
		WHEN SD.[POPULARIDADE SAI] >= 8 THEN 'R-45D' -- PELO MENOS UMA VEZ/45 DIAS
		WHEN SD.[POPULARIDADE SAI] >= 4 THEN 'R-90D' -- PELO MENOS UMA VEZ/TRIMESTRE
		WHEN SD.[POPULARIDADE SAI] < 4 THEN 'S-BAIXO' -- BAIXO MOVIMENTO
		ELSE 'ERRO'
	END AS 'CLASSE PQR'
FROM SALDOS AS SD