SELECT
	Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112) END AS 'DT DIGITAÇÃO',
	CASE WHEN SD1010.D1_TES = '   ' THEN 'NÃO CLASSIFICADA' ELSE 'CLASSIFICADA' END AS 'CLASSIFICAÇÃO',	
	COUNT(DISTINCT SD1010.D1_DOC) AS 'DOCUMENTO',
	SUM(SD1010.D1_TOTAL) AS 'VAL TOTAL'
FROM PROTHEUS.dbo.SD1010 SD1010
	LEFT JOIN PROTHEUS.dbo.Z01010 Z01010 ON Z01010.Z01_CODGER = (SD1010.D1_FILIAL+SD1010.D1_LOCAL) AND Z01010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SF1010 SF1010 ON SD1010.D1_DOC=SF1010.F1_DOC AND SD1010.D1_SERIE=SF1010.F1_SERIE AND SD1010.D1_FORNECE=SF1010.F1_FORNECE AND SD1010.D1_LOJA=SF1010.F1_LOJA AND SF1010.D_E_L_E_T_<>'*'
	LEFT JOIN PROTHEUS.dbo.SF4010 SF4010 ON SF4010.F4_CODIGO=SD1010.D1_TES AND SF4010.D_E_L_E_T_<>'*'
WHERE 
	(SD1010.D_E_L_E_T_<>'*') AND
	(((SF1010.F1_DTDIGIT>='20170101' AND SF1010.F1_DTDIGIT<='20171231') AND ((SF4010.F4_ESTOQUE='S') OR (SF4010.F4_CODIGO='103' OR SF4010.F4_CODIGO='140'))) OR 
	((SF1010.F1_DTDIGIT>='20170101' AND SF1010.F1_DTDIGIT<='20171231') AND (SD1010.D1_CC='          ' AND SD1010.D1_TES='   ')))
GROUP BY 
	Case RTrim(Coalesce(SF1010.F1_DTDIGIT,'')) WHEN ''  THEN Null ELSE convert(datetime,SF1010.F1_DTDIGIT, 112) END,
	CASE WHEN SD1010.D1_TES = '   ' THEN 'NÃO CLASSIFICADA' ELSE 'CLASSIFICADA' END